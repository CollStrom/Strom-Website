"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[218],{120593:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.extractVariablesFromString=function(e){let t=e.match(/{{(.*?)}}/g),n=t?a.default.uniq(t.map(e=>e.replace(/{{|}}/g,"").trim())):[],o=e.match(/{%\s*(if|elsif)\s+(\w+)\s*(==|>|<|>=|<=|!=)/g);return o?.forEach(e=>{let t=e.match(/\b\w+\b/g);t&&t.forEach(e=>{["if","elsif"].includes(e)||n.includes(e)||n.push(e)})}),a.default.uniq(n)},t.fillTemplate=function({template:e,variableMapping:t}){try{let n=function(e){let t={};for(let n in e){let o=e[n];"string"==typeof o?t[n]=o.replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\t/g,"\\t"):t[n]=o}return t}(t),o=r.parseAndRenderSync(e,n);return o??""}catch{return""}};var o,a=(o=n(298784))&&o.__esModule?o:{default:o},i=n(284040);let r=new i.Liquid({strictFilters:!0,strictVariables:!1})},900218:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.isVisibleInLowerReviewLevel=function(e,t){let n=o.default.filter(o.default.values(s.ReviewLevel),e=>e<=t);return o.default.some(n,t=>isStepVisible(e,t))},t.isStepReadonly=isStepReadonly,t.isStepEligibleForFeedback=function(e,t){return isStepVisible(e,t)&&!isStepReadonly(e,t)},t.producePromptWithReferenceTexts=producePromptWithReferenceTexts,t.getMostRecentModelSelectorResponseForTurn=getMostRecentModelSelectorResponseForTurn,t.getTurnCount=t.constructChatHistory=t.getMostRecentModelSelectorResponseForTurnWithTurnResponses=t.isConditionallyVisible=t.isStepVisible=t.isStepSequentiallySkippedAndVisible=t.getEmptyContextForStepType=t.getNullContextForStepType=void 0;var o=_interopRequireDefault(n(298784)),a=_interopRequireDefault(n(711719)),i=n(854358),r=n(963494),s=n(599789),l=n(907777),p=n(959944),d=n(844159),u=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e){for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n)){var o=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,n):{};o.get||o.set?Object.defineProperty(t,n,o):t[n]=e[n]}}return t.default=e,t}(n(120593));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.keys(u).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===u[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return u[e]}}))});let getNullContextForStepType=e=>{switch(e){case i.InteractionStepType.MetadataViewer:case i.InteractionStepType.ContextDirections:case i.InteractionStepType.Instruction:case i.InteractionStepType.PromptInput:case i.InteractionStepType.HistoryViewer:return{};case i.InteractionStepType.MultiTurnContinue:return{message:"",shouldContinue:!0};case i.InteractionStepType.ModelResponseSelector:case i.InteractionStepType.ModelResponsePreview:return{messages:[],candidates:[],displayOrder:[],selectedIndex:-1,selectedId:""};case i.InteractionStepType.QuantitativeModelResponseSelector:return{candidates:[],selectedId:"",response:{annotations:{}}};case i.InteractionStepType.ModelResponseEditor:return{baseResponse:"",originalText:""};case i.InteractionStepType.MetadataEditor:return{baseMetadata:"",metadataType:"plaintext"};case i.InteractionStepType.ModelResponseRanking:return{rankedCandidates:[]};case i.InteractionStepType.PromptTextCollection:case i.InteractionStepType.AudioTextCollection:case i.InteractionStepType.QIRTextCollection:case i.InteractionStepType.QualityMeasurement:case i.InteractionStepType.TextCollection:return{response:{annotations:{}}};case i.InteractionStepType.TextCollectionPerResponse:return{candidates:[],annotations:{}};case i.InteractionStepType.ProcessSupervision:return{chunks:[]};case i.InteractionStepType.SpanFeedback:return{comments:[]};case i.InteractionStepType.ExperimentalToolUse:return{chunks:[],shouldContinue:!1};case i.InteractionStepType.ExternalApp:default:return{}}};t.getNullContextForStepType=getNullContextForStepType,t.getEmptyContextForStepType=e=>{switch(e.type){case i.InteractionStepType.ContextDirections:case i.InteractionStepType.Instruction:return{};case i.InteractionStepType.ModelResponseSelector:return{messages:[],candidates:[],displayOrder:[],selectedIndex:e.params.skip_selection?-1:0,selectedId:""};case i.InteractionStepType.MultiTurnContinue:return{message:"",shouldContinue:!0};case i.InteractionStepType.NER:return{response:{annotations:[]}};case i.InteractionStepType.PromptInput:return{};case i.InteractionStepType.QIRTextCollection:return{response:{annotations:{}}};case i.InteractionStepType.SearchAutoComplete:return{prompt:"",candidates:[],searchHistory:[],additionalReferences:[]};case i.InteractionStepType.SearchReferences:return{prompt:"",candidates:[],additionalReferences:[]};case i.InteractionStepType.ProcessSupervision:case i.InteractionStepType.ExperimentalToolUse:case i.InteractionStepType.ToolUseProcessSupervision:return{chunks:[]};case i.InteractionStepType.SpanFeedback:return{comments:[]};case i.InteractionStepType.ChainOfThought:return{responses:[]};default:return{}}},t.isStepSequentiallySkippedAndVisible=(e,t,n,o,a)=>{let r=t.at(n),s=e.at(n);if(!r||!s||r?.contextType!==i.ContextType.Skipped||!isStepVisible(s,o))return!1;let l=e.filter(e=>e.stage===s.stage&&e.turn===s.turn&&e.responseIndex<s.responseIndex).map(e=>[e,t.at(e.responseIndex)]),p=l.some(([e,n])=>!!e&&!!n&&n.contextType===i.ContextType.Skipped&&isStepVisible(e,o)&&isConditionallyVisible(e,t,e.responseIndex,a,o));return p};let isStepVisible=(e,t)=>!!(o.default.isNil(t)||[s.ReviewLevel.CorpFlagged,s.ReviewLevel.Deliverable].includes(t))||!e.params.visibility_restricted||!!e.params.visibility_restricted.includes(t);t.isStepVisible=isStepVisible;let isConditionallyVisible=(e,t,n,o,a)=>{let i=e.params.conditional_visibility;if(!i)return!0;let r=t.slice(0,n);return p.conditionalVisibilityCheckerStrategy(i,r,e.turn+1,o,a)};function isStepReadonly(e,t){return!o.default.isNil(t)&&(e.params.readonly_review_levels?.includes(t)??!1)}function producePromptWithReferenceTexts(e,t=!1){let n=e.context?.referenceTexts;if(n&&n.length>0){let o="";for(let e in n){let a=n[e].content,i=n[e]?.category;null!=i&&(o+=t?`${i}
`:`Reference category: "${i}"
`),o+=t?`${a}

`:`Reference text: "${a}"

`}return t?`${e.output}

${o}`:`${o}Prompt: ${e.output}`}return e.output}function getMostRecentModelSelectorResponseForTurn(e,t,n){let o=e.filter(e=>n[e.index]?.turn===t);return getMostRecentModelSelectorResponseForTurnWithTurnResponses(o)}t.isConditionallyVisible=isConditionallyVisible;let getMostRecentModelSelectorResponseForTurnWithTurnResponses=e=>{let t=e.filter(e=>e.type===i.InteractionStepType.ModelResponseSelector&&e.contextType!==i.ContextType.Skipped).at(-1),n=t?.context?.selectedId,o=t?.context?.candidates?.find(e=>e.id===n);return o?o.message.content??"":t?.context?.candidates?.[0]?.message.content??""};t.getMostRecentModelSelectorResponseForTurnWithTurnResponses=getMostRecentModelSelectorResponseForTurnWithTurnResponses,t.constructChatHistory=({responses:e,config:t,stepParamsWithStage:n,responseIndex:a})=>{e=o.default.isNil(a)?e:e.slice(0,a);let{prevMessages:s}=l.extractPrefilledMessages(t.initialMessages),p=s.map(e=>({role:e.role,content:e.content||""})),u=e.slice(0,t.before.length).find(e=>e.type===i.InteractionStepType.PromptInput);if(!u)return[];let c={role:i.MessageRole.User,content:producePromptWithReferenceTexts(u,t.useAppendedReferenceText),attachments:u.context?.attachments},f=[],y=n.slice(0,a).filter(e=>e.stage===d.ChatTaskParamsStages.Turn&&e.type===i.InteractionStepType.MultiTurnContinue);y?.forEach(o=>{let a=e.at(o.responseIndex);if(!a)return;let r=a.context,s=r.message.length?r.message:getMostRecentModelSelectorResponseForTurn(e,o.turn,n),l={role:i.MessageRole.Assistant,content:s,attachments:r.modelResponseAttachments,messageMetadata:r.modelResponseMetadata};if(!r.shouldContinue){f.push(l);return}let p={role:r.role||i.MessageRole.User,content:producePromptWithReferenceTexts(a,t.useAppendedReferenceText),attachments:r.attachments,skipMessage:r.skipPromptInput||!1};return f.push(l,p)});let m=[];for(let t of n){if(t.type!==i.InteractionStepType.TextCollection||!t.params.save_as_system_message)continue;let n=t.params.fields.filter(e=>e.type===r.TextCollectionFieldType.Text);if(1!==n.length)break;let o=n[0].field_id,a=e[t.responseIndex],s=a.context.response.annotations[o],l=s?.response?.[0];l&&m.push({role:i.MessageRole.System,content:l})}m.length>1&&(m=[]);let g=[...m,...p,c,...f];return g},t.getTurnCount=e=>(e??[]).filter(e=>e?.type===i.InteractionStepType.MultiTurnContinue).length,t.ChatHistory=class{createNewTurnStepParams(e,t){return[...this.params.turn,{id:a.default.v4(),type:i.InteractionStepType.MultiTurnContinue,params:{instructions:"Continue with the prompt or end your session."}}].map((n,o)=>({...n,stage:d.ChatTaskParamsStages.Turn,turn:e,responseIndex:t+o}))}getNullContext(e){return getNullContextForStepType(e.type)}getStepsWithResponses(){let e=[...this.response.responses],t=this.params.before.map((e,t)=>({...e,stage:d.ChatTaskParamsStages.Before,turn:-1,responseIndex:t})),n=e.slice(0,t.length),a=l.validateStepTypes(t.map(e=>e.type).slice(0,n.length),n);if(!a)throw Error("[ChatHistory] Invalid before step responses");e=e.slice(t.length);let r=this.params.turn.length+1,s=[],p=[],u=[],c=0;for(;e.length>0;){let n=this.createNewTurnStepParams(c,t.length+s.length*r),o=e.slice(0,n.length),a=l.validateStepTypes(n.map(e=>e.type).slice(0,o.length),o);if(!a)throw Error("[ChatHistory] Invalid turn step responses");if(s.push({stepParams:n,responses:o}),e=e.slice(n.length),o.length!==r)break;c+=1;let f=o[o.length-1];if(f.type!==i.InteractionStepType.MultiTurnContinue)throw Error("[ChatHistory] Invalid last step in a turn");let y=f.context;if(!y.shouldContinue){let n=t.length+s.length*r;p=this.params.after.map((e,t)=>({...e,stage:d.ChatTaskParamsStages.After,turn:-1,responseIndex:n+t})),u.push(...e);let o=l.validateStepTypes(p.map(e=>e.type).slice(0,u.length),u);if(!o)throw Error("[ChatHistory] Invalid after step responses");break}}let f=o.default.zip(t,n),y=o.default.zip(p,u);return{before:f,turns:s,after:y}}getFlattenedStepsWithResponses(){let{before:e,turns:t,after:n}=this.getStepsWithResponses();return[...e,...t.flatMap(e=>o.default.zip(e.stepParams,e.responses)),...n]}getCompletedSteps(e){let t=this.getFlattenedStepsWithResponses(),n={};for(let o=0;o<t.length;o++){let[a,r]=t[o];if(!a||!r)break;r.contextType===i.ContextType.Skipped&&isStepVisible(a,e)&&isConditionallyVisible(a,this.response.responses,o,void 0,e)?n[o]=!1:n[o]=!0}return n}constructor(e,t){this.params=e,this.response=t,this.findTurnParamsByStepType=e=>this.params.turn.filter(t=>t.type===e),this.findTurnTextCollectionUnitFieldByFieldId=e=>{let t=this.findTurnParamsByStepType(i.InteractionStepType.TextCollection),n=t?.find(t=>t.params.fields.find(t=>t.field_id===e));return n?.params.fields.find(t=>t.field_id===e)},this.findTurnTextCollectionUnitFieldResponseByFieldId=e=>{let t=this.findResponsesByStepType(i.InteractionStepType.TextCollection),n=t?.find(t=>t.context.response.annotations[e]?.response);return n?.context.response.annotations[e]},this.findResponsesByStepType=e=>this.response.responses.filter(t=>t.type===e),this.findModelResponseSelectorResponseSelectedCandidateByIndex=e=>this.response.responses[e].context?.candidates?.find(t=>t.index===this.response.responses[e].context?.selectedIndex),this.params=e,this.response=t}}},108305:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.maybeSanitizeResponseV2Impl=function(e,t){let n=[...t.before.map(t=>getMatchedOrSkippedStepResponse(t,e,"before")),...function(e,t){let n=e.turn,o=[...e.before,...n,...e.after],s=!a.default.isEmpty(e.endSessionCondition),l=n.map(n=>{let a=o.filter(e=>e.id===n.id).length>1;return getMatchedOrSkippedTurnStepResponses(n,t,a,s,toIntegerOrUndefined(e.minTurns),toIntegerOrUndefined(e.maxTurns))}),p=[],d=l.length?l[0].length:1;for(let e=0;e<d;e++){for(let t of l)p.push(t[e]);p.push(function(e,t){let n=e.responses.filter(e=>e.type===i.InteractionStepType.MultiTurnContinue),o=n[t];if(n.length&&(!o||o.step_id)){if(!o){let e=n[0];o={type:i.InteractionStepType.MultiTurnContinue,context:{...e.context,message:""},output:"",contextType:i.ContextType.Skipped,index:-1,step_id:e.step_id}}}else throw new SanitizationError(r.UnsupportedTaskReason.NoPrompt);if(!o.step_id)throw new SanitizationError(r.UnsupportedTaskReason.NoPrompt);let a={step_id:o.step_id,step_type:i.InteractionStepType.MultiTurnContinue,matching_response:o};return a}(t,e))}return p}(t,e),...t.after.map(t=>getMatchedOrSkippedStepResponse(t,e,"after"))],o=propagateOutputAndIndexes(n.map(e=>e.matching_response)),s=fixMTCContext(o),l={...e,responses:s};return{newResponse:l,matchResults:n}},t.getMatchedOrSkippedStepResponse=getMatchedOrSkippedStepResponse,t.maybeSanitizeWithinStepResponse=maybeSanitizeWithinStepResponse,t.getMatchedOrSkippedTurnStepResponses=getMatchedOrSkippedTurnStepResponses,t.getSkippedStepResponse=getSkippedStepResponse,t.fixMTCContext=fixMTCContext,t.propagateOutputAndIndexes=propagateOutputAndIndexes,t.populateTemplateVariables=function(e,t){if(!t)return e;{e.templateVariables=t;let n=function replaceVariables(e,t){if(Array.isArray(e))return e.map(e=>replaceVariables(e,t));if("object"==typeof e&&null!==e){let n={};for(let o in e)Object.prototype.hasOwnProperty.call(e,o)&&(n[o]=replaceVariables(e[o],t));return n}if("string"!=typeof e)return e;{let n=e;for(let e in t)if(Object.prototype.hasOwnProperty.call(t,e)){let o=RegExp(`^{{ *?${e} *?\\| *?toJson *?}}$`,"i");if(o.test(n))try{return JSON.parse(t[e])}catch(e){}let a=RegExp(`{{ *?${e} *?}}`,"gi");n=n.replace(a,t[e])}return n}}(e,t);return n}},t.OUTPUT_PLACEHOLDER=void 0;var o,a=(o=n(298784))&&o.__esModule?o:{default:o},i=n(854358),r=n(147460),s=n(900218);let SanitizationError=class SanitizationError extends Error{constructor(e){super(e),this.name="SanitizationError"}};t.SanitizationError=SanitizationError;let l="[[__OUTPUT_PLACEHOLDER__]]";function getMatchedOrSkippedStepResponse(e,t,n){let o={step_id:e.id,step_type:e.type,turn_number:n,matching_response:getSkippedStepResponse(e)},a=t.responses.filter(e=>e.step_id===o.step_id&&e.type===o.step_type);if(0===a.length)o.empty_reason=r.EmptyStepReason.NewStep;else if(a.length>1)throw new SanitizationError(r.UnsupportedTaskReason.DuplicateStepId);else o.matching_response=maybeSanitizeWithinStepResponse(e,a[0]);return o}function maybeSanitizeWithinStepResponse(e,t){if(e.type===i.InteractionStepType.TextCollectionPerResponse){let n=e.params.fields.map(e=>e.field_id),o=Object.keys(t.context.annotations);for(let e of o)t.context.annotations[e].annotations=filterAnnotations(t.context.annotations[e].annotations,n)}else if([i.InteractionStepType.TextCollection,i.InteractionStepType.QIRTextCollection].includes(e.type)){let n=e.params.fields.map(e=>e.field_id);t.context.response.annotations=filterAnnotations(t.context.response.annotations,n)}return t}function filterAnnotations(e,t){return Object.fromEntries(Object.entries(e).filter(([e])=>t.includes(e)))}function getMatchedOrSkippedTurnStepResponses(e,t,n,o,a,s){let l=function(e,t,n,o){let a=e.responses.filter(e=>e.type===i.InteractionStepType.MultiTurnContinue).length;return n&&n>a&&!t?n:o&&o<a?o:a}(t,o,a,s),p=[],d=t.responses.filter(t=>t.step_id===e.id&&t.type===e.type);for(let t=0;t<l;t++){let o={step_id:e.id,step_type:e.type,turn_number:t+1,matching_response:getSkippedStepResponse(e)};if(n)throw new SanitizationError(r.UnsupportedTaskReason.DuplicateStepId);d.length?d.length<=t?o.empty_reason=r.EmptyStepReason.NewRequiredTurns:o.matching_response=maybeSanitizeWithinStepResponse(e,d[t]):o.empty_reason=r.EmptyStepReason.NewStep,p.push(o)}return p}function toIntegerOrUndefined(e){let t=a.default.toInteger(e);return a.default.isNaN(t)?void 0:t}function getSkippedStepResponse(e){let t={output:l,contextType:i.ContextType.Skipped,index:-1,step_id:e.id,type:e.type,context:s.getNullContextForStepType(e.type)};return t}function fixMTCContext(e){let t=e.filter(e=>e.type===i.InteractionStepType.MultiTurnContinue);if(!t.length)throw new SanitizationError(r.UnsupportedTaskReason.NoPrompt);for(let e=0;e<t.length;e++){let n=t[e];if(e!==t.length-1){let e=a.default.omit(n.context,["message","shouldContinue"]);n.context={message:n.context.message,shouldContinue:!0,...e}}else n.context={message:n.context.message,shouldContinue:!1},n.output=""}return e}function propagateOutputAndIndexes(e){let t=[];for(let n=0;n<e.length;n++){let o=e[n],a=o.output===l&&n>0?t[n-1].output:o.output===l?"":o.output;t.push({...o,index:n,output:a})}return t}t.OUTPUT_PLACEHOLDER=l},959944:function(e,t){function extractFieldAnnotation(e,t){return e.context.response.annotations[t.field_id]}function extractConditionalBase(e,t){return t.filter(t=>t.step_id===e.id).at(-1)}Object.defineProperty(t,"__esModule",{value:!0}),t.conditionalVisibilityCheckerStrategy=function conditionalVisibilityCheckerStrategy(e,t,n,o,a){var i,r;switch(e.type){case"AND":return e.params.every(e=>conditionalVisibilityCheckerStrategy(e,t,n,o,a));case"OR":return e.params.some(e=>conditionalVisibilityCheckerStrategy(e,t,n,o,a));case"NOT":return!conditionalVisibilityCheckerStrategy(e.params,t,n,o,a);case"TextCollection":return!(i=extractConditionalBase(e,t))||function isFieldConfigFulfilled(e,t){switch(t.type){case"boolean":{let n=extractFieldAnnotation(e,t),o=n?.response?.at(0);if(void 0===o)return!1;return o&&t.value||!o&&!t.value}case"text":{let n=extractFieldAnnotation(e,t),o=n?.response?.at(0);if(void 0===o)return!1;return function(e,t){switch(t.operator){case"eq":return e===t.value;case"contains":return e.includes(t.value);case"startsWith":return e.startsWith(t.value);case"endWith":return e.endsWith(t.value);default:return!0}}(o,t)}case"number":{let n=extractFieldAnnotation(e,t),o=n?.response?.at(0);if(void 0===o)return!1;return function(e,t){switch(t.operator){case"eq":return Number(e)===t.value;case"lt":return Number(e)<t.value;case"lte":return Number(e)<=t.value;case"gt":return Number(e)>t.value;case"gte":return Number(e)>=t.value;default:return!0}}(o,t)}case"category":{let n=extractFieldAnnotation(e,t);if(void 0===n)return!1;let o=n.response;if(!o.length)return!1;return o.flat().includes(t.value)}case"AND":return t.params.every(t=>isFieldConfigFulfilled(e,t));case"OR":return t.params.some(t=>isFieldConfigFulfilled(e,t));case"NOT":return!isFieldConfigFulfilled(e,t.params);default:return!0}}(i,e.params.fields);case"ModelResponseSelector":return!(r=extractConditionalBase(e,t))||r.context.selectedId===e.params.modelId;case"Turn":return e.params.turns.includes(n);case"TemplateVariable":return!!o&&e.params.values.includes(o[e.params.variable]);case"ReviewLevel":return void 0===a||void 0!==a&&e.params.reviewLevels.map(String).includes(a.toString());default:return!0}}},677686:function(e,t){Object.defineProperty(t,"__esModule",{value:!0});let ChatTransformWarning=class ChatTransformWarning extends Error{constructor(e){super(e),Object.setPrototypeOf(this,ChatTransformWarning.prototype)}};t.ChatTransformWarning=ChatTransformWarning},936944:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.transformResponse=function(e,t,n){let o=[...t.before.filter(e=>e.params.hide_from_customer_view),...t.turn.filter(e=>e.params.hide_from_customer_view),...t.after.filter(e=>e.params.hide_from_customer_view)].map(e=>e.id),a=n?cleanUnmetConditionalResponses(e,t):e,i=p.formatRawStepResponse({taskParams:t,stepResponses:a.responses}),u=r.default.max(i.filter(e=>r.default.isNumber(e.turnId)).map(e=>e.turnId)),c=r.default.isNumber(u)?u+1:0,f=i.map(e=>({turnId:e.turnId,responses:e.stepResponsesWithParams.map(e=>{let t=y[e.stepResponse.type];return t({response:e.stepResponse,params:e.stepParams,turnId:e.turnId})}).filter(e=>!!e).filter(e=>!o.includes(e.params.id))}));return{turns:f,messages:function(e,t){let{prevMessages:n}=s.extractPrefilledMessages(t.initialMessages),o=n.map(e=>({role:e.role,content:e.content||""})),a=[...o],i=e.filter(e=>"before"!==e.turnId&&"after"!==e.turnId);for(let e of i){let t=e.stepResponsesWithParams;if(!t||0===t.length)throw Error("Invalid turnStepResponsesWithParams");let n=t.find(e=>e.stepResponse.type===l.InteractionStepType.PromptInput||e.stepResponse.type===l.InteractionStepType.MultiTurnContinue);if(!n)continue;let o=n.stepResponse.output,i=t[t.length-1].stepResponse.output;if("string"!=typeof o)throw Error("Prompt is not a string");let r=t.find(e=>e.stepResponse.type===l.InteractionStepType.PromptInput||e.stepResponse.type===l.InteractionStepType.MultiTurnContinue)?.stepResponse?.context?.attachments;a.push(...[{role:l.MessageRole.User,content:o,...r?.length&&{attachments:r}},{role:l.MessageRole.Assistant,content:i||d.getMostRecentModelSelectorResponseForTurnWithTurnResponses(t.map(e=>e.stepResponse))}])}return a}(i,t),numTurns:c}},t.cleanUnmetConditionalResponses=cleanUnmetConditionalResponses,t.InternalStepTypeToTransformedStepTypeMap=t.ChatTaskTransformedStepResponseType=void 0;var o,a,i,r=(o=n(298784))&&o.__esModule?o:{default:o},s=n(907777),l=n(854358),p=n(142486),d=n(900218),u=n(108305),c=n(900218);t.ChatTaskTransformedStepResponseType=i,(a=i||(t.ChatTaskTransformedStepResponseType=i={})).Prompt="prompt",a.BasicInput="basic_input",a.PromptTextCollection="prompt_text_collection",a.ModelResponseSelector="model_response_selector",a.QuantitativeModelResponseSelector="quantitative_model_response_selector",a.ResponseTextCollection="response_text_collection",a.ModelResponseEditor="model_response_editor",a.MetadataEditor="metadata_editor",a.ModelResponseRanking="model_response_ranking",a.GenericAnnotation="generic_annotation",a.GenericAnnotationPerModelResponse="generic_annotation_per_model_response",a.NamedEntityRecognition="named_entity_recognition",a.NamedEntityRecognitionV2="named_entity_recognition_v2",a.SearchAutoComplete="search_auto_complete",a.SearchReferences="search_references",a.ProcessSupervision="process_supervision",a.ExperimentalToolUse="experimental_tool_use",a.ToolUseProcessSupervision="tool_use_process_supervision",a.ModelResponseSelectorJustificationVariable="model_response_selector_justification_variable",a.SpanFeedback="span_feedback",a.Unknown="unknown";let f={[l.InteractionStepType.PromptInput]:i.Prompt,[l.InteractionStepType.BasicInput]:i.BasicInput,[l.InteractionStepType.PromptTextCollection]:i.PromptTextCollection,[l.InteractionStepType.MultiTurnContinue]:i.Prompt,[l.InteractionStepType.ModelResponseSelector]:i.ModelResponseSelector,[l.InteractionStepType.QuantitativeModelResponseSelector]:i.QuantitativeModelResponseSelector,[l.InteractionStepType.ResponseTextCollection]:i.ResponseTextCollection,[l.InteractionStepType.ModelResponseEditor]:i.ModelResponseEditor,[l.InteractionStepType.MetadataEditor]:i.MetadataEditor,[l.InteractionStepType.ModelResponseRanking]:i.ModelResponseRanking,[l.InteractionStepType.TextCollection]:i.GenericAnnotation,[l.InteractionStepType.TextCollectionPerResponse]:i.GenericAnnotationPerModelResponse,[l.InteractionStepType.NER]:i.NamedEntityRecognition,[l.InteractionStepType.NER_V2]:i.Unknown,[l.InteractionStepType.SearchAutoComplete]:i.SearchAutoComplete,[l.InteractionStepType.SearchReferences]:i.SearchReferences,[l.InteractionStepType.Instruction]:void 0,[l.InteractionStepType.MetadataViewer]:void 0,[l.InteractionStepType.ContextDirections]:void 0,[l.InteractionStepType.QIRTextCollection]:void 0,[l.InteractionStepType.QualityMeasurement]:void 0,[l.InteractionStepType.ProcessSupervision]:i.ProcessSupervision,[l.InteractionStepType.ExperimentalToolUse]:i.ExperimentalToolUse,[l.InteractionStepType.ToolUseProcessSupervision]:i.ToolUseProcessSupervision,[l.InteractionStepType.SpanFeedback]:i.SpanFeedback,[l.InteractionStepType.ChainOfThought]:i.Unknown,[l.InteractionStepType.ModelResponseInput]:i.Unknown,[l.InteractionStepType.UnitTestCollection]:i.Unknown,[l.InteractionStepType.AudioFullDuplex]:i.Unknown,[l.InteractionStepType.AudioTextCollection]:i.Unknown,[l.InteractionStepType.ExternalApp]:i.Unknown,[l.InteractionStepType.MultiChat]:i.Unknown,[l.InteractionStepType.HistoryViewer]:i.Unknown,[l.InteractionStepType.ModelResponsePreview]:i.Unknown,[l.InteractionStepType.Voting]:i.Unknown,[l.InteractionStepType.RubricCriteriaBuilder]:i.Unknown,[l.InteractionStepType.RubricCriteriaRating]:i.Unknown,[l.InteractionStepType.RubricEvaluationViewer]:i.Unknown,[l.InteractionStepType.GenUI]:i.Unknown,[l.InteractionStepType.AgentEnvironment]:i.Unknown,[l.InteractionStepType.AgentExecution]:i.Unknown,[l.InteractionStepType.AudioRecording]:i.Unknown,[l.InteractionStepType.AudioPlayer]:i.Unknown,[l.InteractionStepType.MultiChannelAudio]:i.Unknown,[l.InteractionStepType.ProcessSupervisionAgentExecution]:i.Unknown};t.InternalStepTypeToTransformedStepTypeMap=f;let y={[l.InteractionStepType.PromptInput]:({response:e,turnId:t,params:n})=>{let o=e.context?.referenceTexts,a=e.context?.attachments;return{__internalType:e.type,params:n,type:f[e.type],turnId:t,data:{prompt:e.output,...o?.length&&{referenceTexts:o},...a?.length&&{attachments:a}},responsesIndex:e.index,stepId:n.id}},[l.InteractionStepType.BasicInput]:({response:e,turnId:t,params:n})=>({__internalType:e.type,params:n,type:f[e.type],turnId:t,data:{input:e.output},responsesIndex:e.index,stepId:n.id}),[l.InteractionStepType.PromptTextCollection]:({response:e,turnId:t,params:n})=>({__internalType:e.type,params:n,type:f[e.type],turnId:t,responsesIndex:e.index,stepId:n.id,data:{annotations:e.context.response.annotations}}),[l.InteractionStepType.ModelResponseSelector]:({response:e,turnId:t,params:n})=>({__internalType:e.type,params:n,type:f[e.type],turnId:t,responsesIndex:e.index,stepId:n.id,data:{modelResponses:r.default.fromPairs(e.context.candidates.map(e=>[e.id,e.message.content])),reactUIGeneratedUrls:r.default.fromPairs(e.context.candidates.map(e=>[e.id,e.reactUIGeneratedUrl])),modelParams:r.default.fromPairs(e.context.candidates.map(e=>[e.id,e.endpoint?.params??e.additionalData])),messageMetadata:r.default.fromPairs(e.context.candidates.map(e=>[e.id,e.message.messageMetadata])),modelReasoning:r.default.fromPairs(e.context.candidates.map(e=>[e.id,e.message.reasoning])),selectedModelId:e.context.selectedId,...r.default.omitBy({isObjective:e.context.isObjective,likertValue:e.context.likertValueUnrandomized,justification:e.context.justificationUnrandomized},r.default.isNil)}}),[l.InteractionStepType.QuantitativeModelResponseSelector]:({response:e,turnId:t,params:n})=>({__internalType:e.type,params:n,type:f[e.type],turnId:t,responsesIndex:e.index,stepId:n.id,data:{modelResponses:r.default.fromPairs(e.context.candidates.map(e=>[e.id,e.message.content])),reactUIGeneratedUrls:r.default.fromPairs(e.context.candidates.map(e=>[e.id,e.reactUIGeneratedUrl])),modelParams:r.default.fromPairs(e.context.candidates.map(e=>[e.id,e.endpoint?.params??e.additionalData])),messageMetadata:r.default.fromPairs(e.context.candidates.map(e=>[e.id,e.message.messageMetadata])),modelReasoning:r.default.fromPairs(e.context.candidates.map(e=>[e.id,e.message.reasoning])),selectedModelId:e.context.selectedId,response:e.context.response}}),[l.InteractionStepType.ResponseTextCollection]:({response:e,turnId:t,params:n})=>({__internalType:e.type,params:n,type:f[e.type],turnId:t,responsesIndex:e.index,stepId:n.id,data:{responseId:e.context.responseId,annotations:e.context.response}}),[l.InteractionStepType.ModelResponseEditor]:({response:e,turnId:t,params:n})=>({__internalType:e.type,params:n,type:f[e.type],turnId:t,responsesIndex:e.index,stepId:n.id,data:{originalResponse:e.context.originalText??"",modelResponse:e.output.replaceAll("&#x20;"," "),...e.context.originalMetadata&&{originalMetadata:e.context.originalMetadata},...e.context.messageMetadata&&{updatedMetadata:e.context.messageMetadata},...e.context.reactUIGeneratedUrl&&{reactUIGeneratedUrl:e.context.reactUIGeneratedUrl}}}),[l.InteractionStepType.MetadataEditor]:({response:e,turnId:t,params:n})=>({__internalType:e.type,params:n,type:f[e.type],turnId:t,responsesIndex:e.index,stepId:n.id,data:{originalContent:e.context.baseMetadata??"",content:e.output.replaceAll("&#x20;"," ")}}),[l.InteractionStepType.ModelResponseRanking]:({response:e,turnId:t,params:n})=>({__internalType:e.type,params:n,type:f[e.type],turnId:t,responsesIndex:e.index,stepId:n.id,data:{rankedCandidateIds:e.context.rankedCandidates.map(e=>e.map(e=>e.id))}}),[l.InteractionStepType.TextCollection]:({response:e,turnId:t,params:n})=>({__internalType:e.type,params:n,type:f[e.type],turnId:t,responsesIndex:e.index,stepId:n.id,data:{annotations:e.context.response.annotations}}),[l.InteractionStepType.TextCollectionPerResponse]:({response:e,turnId:t,params:n})=>({__internalType:e.type,params:n,type:f[e.type],turnId:t,responsesIndex:e.index,stepId:n.id,data:r.default.fromPairs(Object.entries(e.context.annotations).map(([e,{annotations:t}])=>[e,{annotations:t}]))}),[l.InteractionStepType.NER]:({response:e,turnId:t,params:n})=>({__internalType:e.type,params:n,type:f[e.type],turnId:t,responsesIndex:e.index,stepId:n.id,data:{annotations:e.context.response}}),[l.InteractionStepType.NER_V2]:()=>void 0,[l.InteractionStepType.MultiTurnContinue]:({response:e,turnId:t,params:n})=>{if(!e.context.shouldContinue)return;let o=e.context?.referenceTexts,a=e.context?.attachments;return{__internalType:e.type,params:n,type:f[e.type],turnId:t,data:{prompt:e.output,...o?.length&&{referenceTexts:o},...a?.length&&{attachments:a}},responsesIndex:e.index,stepId:n.id}},[l.InteractionStepType.SearchAutoComplete]:({response:e,turnId:t,params:n})=>({__internalType:e.type,params:n,type:f[e.type],turnId:t,responsesIndex:e.index,stepId:n.id,data:{finalResponse:e.output,modelResponses:r.default.fromPairs(e.context.candidates.map(e=>[e.sourceId??e.index.toString(),e.message.content])),searchHistory:e.context.searchHistory,additionalReferences:e.context.additionalReferences}}),[l.InteractionStepType.SearchReferences]:({response:e,turnId:t,params:n})=>({__internalType:e.type,params:n,type:f[e.type],turnId:t,responsesIndex:e.index,stepId:n.id,data:{finalResponse:e.output,references:e.context.references}}),[l.InteractionStepType.Instruction]:()=>void 0,[l.InteractionStepType.MetadataViewer]:()=>void 0,[l.InteractionStepType.ContextDirections]:()=>void 0,[l.InteractionStepType.QIRTextCollection]:()=>void 0,[l.InteractionStepType.QualityMeasurement]:()=>void 0,[l.InteractionStepType.ProcessSupervision]:({response:e,turnId:t,params:n})=>({__internalType:l.InteractionStepType.ProcessSupervision,params:n,type:f[l.InteractionStepType.ProcessSupervision],turnId:t,responsesIndex:e.index,stepId:n.id,data:{...e}}),[l.InteractionStepType.ExperimentalToolUse]:({response:e,turnId:t,params:n})=>({__internalType:e.type,params:n,type:f[l.InteractionStepType.ExperimentalToolUse],turnId:t,responsesIndex:e.index,stepId:n.id,data:{...e}}),[l.InteractionStepType.ToolUseProcessSupervision]:({response:e,turnId:t,params:n})=>({__internalType:l.InteractionStepType.ToolUseProcessSupervision,params:n,type:f[l.InteractionStepType.ToolUseProcessSupervision],turnId:t,responsesIndex:e.index,stepId:n.id,data:{...e}}),[l.InteractionStepType.SpanFeedback]:({response:e,turnId:t,params:n})=>({__internalType:l.InteractionStepType.SpanFeedback,params:n,type:f[l.InteractionStepType.SpanFeedback],turnId:t,responsesIndex:e.index,stepId:n.id,data:{...e}}),[l.InteractionStepType.ChainOfThought]:()=>void 0,[l.InteractionStepType.ModelResponseInput]:()=>void 0,[l.InteractionStepType.MultiChat]:()=>void 0,[l.InteractionStepType.UnitTestCollection]:()=>void 0,[l.InteractionStepType.AudioFullDuplex]:()=>void 0,[l.InteractionStepType.AudioTextCollection]:()=>void 0,[l.InteractionStepType.ExternalApp]:()=>void 0,[l.InteractionStepType.HistoryViewer]:()=>void 0,[l.InteractionStepType.ModelResponsePreview]:()=>void 0,[l.InteractionStepType.Voting]:()=>void 0,[l.InteractionStepType.RubricCriteriaBuilder]:()=>void 0,[l.InteractionStepType.RubricCriteriaRating]:()=>void 0,[l.InteractionStepType.RubricEvaluationViewer]:()=>void 0,[l.InteractionStepType.GenUI]:()=>void 0,[l.InteractionStepType.AgentEnvironment]:()=>void 0,[l.InteractionStepType.AgentExecution]:()=>void 0,[l.InteractionStepType.AudioRecording]:()=>void 0,[l.InteractionStepType.AudioPlayer]:()=>void 0,[l.InteractionStepType.MultiChannelAudio]:()=>void 0,[l.InteractionStepType.ProcessSupervisionAgentExecution]:()=>void 0};function cleanUnmetConditionalResponses(e,t){let n=new c.ChatHistory(t,e),o=n.getFlattenedStepsWithResponses(),a=[...e.responses];for(let n=0;n<a.length;n++){let i=a[n],r=o[n][0];r&&i.type!==l.InteractionStepType.MultiTurnContinue&&!d.isConditionallyVisible(r,e.responses,n,t.templateVariables)&&a.splice(n,1,u.getSkippedStepResponse(r))}let i=u.propagateOutputAndIndexes(a),r=u.fixMTCContext(i),s={...e,responses:r};return s}},258269:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.generateEmptyChatResponse=function(e){let t=[],n=0;e.before.forEach(e=>{let o={type:e.type,context:a.getNullContextForStepType(e.type),output:"",index:n,step_id:e.id};t.push(o),n++});let i=Number(e.minTurns??1);for(let r=0;r<i;r++){e.turn.forEach(e=>{let o={type:e.type,context:a.getNullContextForStepType(e.type),output:"",index:n,step_id:e.id};t.push(o),n++});let s=e.before.find(e=>e.type===o.InteractionStepType.PromptInput),l={type:o.InteractionStepType.MultiTurnContinue,context:{...a.getNullContextForStepType(o.InteractionStepType.MultiTurnContinue),shouldContinue:r!==i-1},output:"",index:n,step_id:s?s.id:"prompt"};t.push(l),n++}return e.after.forEach(e=>{let o={type:e.type,context:a.getNullContextForStepType(e.type),output:"",index:n,step_id:e.id};t.push(o),n++}),t};var o=n(854358),a=n(900218)},560411:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.getCommentIsOverallFeedback=function(e){return o.isNil(e.childId)},t.createChatTaskFeedbackEntriesFromResponse=function(e,t,n,i){if(!n||o.isNil(i)||o.isNil(t))return[];let r=new a.ChatHistory(e,{responses:t.responses}),p=r.getFlattenedStepsWithResponses(),c=[],f=-1;for(let[t,r]of p){if(!t||!r)continue;let y=t.type;if(a.isStepEligibleForFeedback(t,i)&&(y===s.InteractionStepType.TextCollection||y===s.InteractionStepType.QualityMeasurement)){let e=Object.values(r.context.response.annotations),a=t.params.fields.filter(e=>(e.type===l.TextCollectionFieldType.Text||e.type===l.TextCollectionFieldType.Number||e.type===l.TextCollectionFieldType.Category)&&e.save_to_task_feedback);e.forEach(e=>{let{field_id:y,type:m,response:g}=e,T=a.find(e=>e.field_id===y);if(t.params.visibility_restricted&&T){let e,a,S;let _=t.params.visibility_restricted.sort((e,t)=>o.isNumber(e)&&o.isNumber(t)?e-t:0);if(m===l.TextCollectionFieldType.Category){let t=T.choices,n=g[0].map(e=>{let n=t.find(t=>t.value===e);return n?n.label:String(e)});n.length&&(e=n,a=s.WorkerCommentType.Category)}else m===l.TextCollectionFieldType.Number?(e=g[0],a=s.WorkerCommentType.Rating):m===l.TextCollectionFieldType.Text&&(e=g[0],a=s.WorkerCommentType.Text);let h=r.type===s.InteractionStepType.QualityMeasurement?_.includes(i):i===_[0],b=T.title;if(r.type===s.InteractionStepType.QualityMeasurement){if(!d.includes(y)){let e=p.slice(0,r.index);S=function(e,t,n){if(e===s.QUALITY_PROMPT_FIELD_ID){let e=getMostRecentVisibleStepForCondition(t,e=>[s.InteractionStepType.PromptInput,s.InteractionStepType.MultiTurnContinue].includes(e.type),n);if(e&&e[1])return`${e[1].type}-${e[1].index}`}else if(e===s.QUALITY_RESPONSE_SELECTION_FIELD_ID){let e=getMostRecentVisibleStepForCondition(t,e=>e.type===s.InteractionStepType.ModelResponseSelector,n);if(e&&e[1])return`${e[1].type}-${e[1].index}`}else if(e===s.QUALITY_RESPONSE_FIELD_ID){let e=getMostRecentVisibleStepForCondition(t,e=>e.type===s.InteractionStepType.ModelResponseEditor,n);if(e&&e[1])return`${e[1].type}-${e[1].index}`}else if(e===s.QUALITY_JUSTIFICATION_FIELD_ID){let e=getMostRecentVisibleStepForCondition(t,e=>e.type===s.InteractionStepType.TextCollection&&e.params.fields.some(e=>e.field_id.includes("justification")),n);if(e&&e[1])return`${e[1].type}-${e[1].index}`}}(y,e,i)}u.includes(y)&&(b=T.description??b)}if(!o.isNil(e)&&h){let t={title:b,response:e,reviewerId:n,source:r.type===s.InteractionStepType.QualityMeasurement?s.WorkerCommentSourceType.QualityMeasurement:s.WorkerCommentSourceType.TextCollection,type:a,childId:S,turn:f>=0?f:void 0,fieldId:y};c.push(t)}}})}y===s.InteractionStepType.MultiTurnContinue&&(r.context.shouldContinue?f++:f=-1),r.index===e.before.length-1&&(f=0)}return c},t.createChatLiteTaskFeedbackEntriesFromResponse=function(e,t,n,i){if(!n||o.isNil(i)||o.isNil(t))return[];let p=[],d=o.concat(e.before,e.turn,e.after,e.voting??[]);for(let e of d){if(e.type!==s.InteractionStepType.TextCollection&&e.type!==s.InteractionStepType.QualityMeasurement&&e.type!==s.InteractionStepType.Voting||!a.isStepEligibleForFeedback(e,i))continue;let d=[];t?.before?.[e.id]&&d.push(t?.before?.[e.id]),t?.after?.[e.id]&&d.push(t?.after?.[e.id]);let u=t?.turns?.map(t=>t[e.id])?.filter(e=>!o.isNil(e));if(u&&(u.length>0&&d.push(...u),t?.voting?.[e.id]&&d.push(t?.voting?.[e.id]),0!==d.length))for(let t of d){if(!t.output)continue;let a="content"in t?.output?t?.output.content:t?.output;for(let[t,i]of Object.entries(a)){let a,d;let u=e.params.fields.find(e=>e.field_id===t);if(u&&(e.id===r.TaxonomyConstant.Eval.StandardStepId.ReviewerFeedback||e.type===s.InteractionStepType.QualityMeasurement||(!("save_to_task_feedback"in u)||u.save_to_task_feedback)&&"save_to_task_feedback"in u)){if(u.type===l.TextCollectionFieldType.Category)a=[i.toString()],d=s.WorkerCommentType.Category;else if(u.type===l.TextCollectionFieldType.Number)a=i.toString(),d=s.WorkerCommentType.Rating;else if(u.type===l.TextCollectionFieldType.Text)a=i.toString(),d=s.WorkerCommentType.Text;else{if(u.type!==l.TextCollectionFieldType.Boolean)continue;a=i.toString(),d=s.WorkerCommentType.Boolean}if(!o.isNil(a)){let e={title:u.title,response:a,reviewerId:n,source:s.WorkerCommentSourceType.QualityMeasurement,type:d,fieldId:t};p.push(e)}}}}}return p},t.getAuthorTagDataForFeedback=t.SENIOR_LABEL_REVIEW_LEVELS=void 0;var o=n(298784),a=n(900218),i=n(599789),r=n(783768),s=n(854358),l=n(963494);let p=[i.ReviewLevel.Corp,i.ReviewLevel.Deliverable];t.SENIOR_LABEL_REVIEW_LEVELS=p;let d=[s.QUALITY_TASK_OVERALL_FIELD_ID,s.QUALITY_INSTRUCTION_FOLLOWING_FIELD_ID,s.QUALITY_FEEDBACK_OVERALL_FIELD_ID],u=[s.QUALITY_RESPONSE_SELECTION_FIELD_ID,s.QUALITY_INSTRUCTION_FOLLOWING_FIELD_ID];function getMostRecentVisibleStepForCondition(e,t,n){return e.filter(([e,o])=>e&&t(e)&&a.isStepVisible(e,n)).at(-1)}t.getAuthorTagDataForFeedback=(e,t)=>{let n=e?.slice(-6),a=n?`Reviewer (${n})`:void 0,i=!o.isNil(t)&&p.includes(t);return{authorLabel:a,isSeniorReview:i}}},907777:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var o={},a=_interopRequireWildcard(n(112690));Object.keys(a).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(o,e))&&(e in t&&t[e]===a[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}}))});var i=_interopRequireWildcard(n(546112));Object.keys(i).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(o,e))&&(e in t&&t[e]===i[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return i[e]}}))});var r=_interopRequireWildcard(n(142486));Object.keys(r).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(o,e))&&(e in t&&t[e]===r[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return r[e]}}))});var s=_interopRequireWildcard(n(936944));Object.keys(s).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(o,e))&&(e in t&&t[e]===s[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}}))});var l=_interopRequireWildcard(n(677686));Object.keys(l).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(o,e))&&(e in t&&t[e]===l[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return l[e]}}))});var p=_interopRequireWildcard(n(560411));Object.keys(p).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(o,e))&&(e in t&&t[e]===p[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return p[e]}}))});var d=_interopRequireWildcard(n(258269));function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t={};if(null!=e){for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n)){var o=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,n):{};o.get||o.set?Object.defineProperty(t,n,o):t[n]=e[n]}}return t.default=e,t}Object.keys(d).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(o,e))&&(e in t&&t[e]===d[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return d[e]}}))})},142486:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.formatRawStepResponse=function({taskParams:e,stepResponses:t}){let n=new s.ChatHistory(e,{responses:t}),{before:o,turns:a,after:l}=n.getStepsWithResponses(),p=[];o.forEach(([e,t])=>{p.push({stepParams:e,stepResponse:t,turnId:t.type===i.InteractionStepType.PromptInput?0:"before"})}),a.forEach((e,t)=>{r.default.zip(e.stepParams,e.responses).forEach(([e,n])=>{let o=t;if(n.type===i.InteractionStepType.MultiTurnContinue){if(!n.context.shouldContinue)return;o=t+1}p.push({stepParams:e,stepResponse:n,turnId:o})})}),l.forEach(([e,t])=>{p.push({stepParams:e,stepResponse:t,turnId:"after"})});let d=[];for(let e of p){let{turnId:t}=e,n=d.find(e=>e.turnId===t);n?n.stepResponsesWithParams.push(e):d.push({turnId:t,stepResponsesWithParams:[e]})}return d},t.legacyFormatRawStepResponse=function({taskParams:e,stepResponses:t}){let n=getStepResponseWithParams(t,e),o=[];for(let e of n){let{turnId:t}=e,n=o.find(e=>e.turnId===t);n?n.stepResponsesWithParams.push(e):o.push({turnId:t,stepResponsesWithParams:[e]})}return o},t.getStepResponseWithParams=getStepResponseWithParams,t.formattedStepResponseToBeforeTurnsAfter=function(e){return e.reduce((e,t)=>("before"===t.turnId?e.before.push(...t.stepResponsesWithParams):"after"===t.turnId?e.after.push(...t.stepResponsesWithParams):(e.turns[t.turnId]?.length||(e.turns[t.turnId]=[]),e.turns[t.turnId].push(...t.stepResponsesWithParams)),e),{before:[],turns:[],after:[]})};var o,a=n(907777),i=n(854358),r=(o=n(298784))&&o.__esModule?o:{default:o},s=n(900218);function getStepResponseWithParams(e,t){let{before:n,turn:o,after:s}=t,l=n.filter(e=>e.type!==i.InteractionStepType.PromptInput),p=n.find(e=>e.type===i.InteractionStepType.PromptInput);if(!p)throw new a.ChatTransformWarning("Prompt input step params not found");let d=[p,...o],u=e.slice(0,n.length).filter(e=>e.type!==i.InteractionStepType.PromptInput);if(u.length!==l.length)throw Error(`Invalid before step responses length: params has ${u.length} before steps, response has ${l.length} before steps`);let c=r.default.find(e,{type:i.InteractionStepType.PromptInput});if(!c)throw Error("PromptInput step response not found");let f=[c,...e.slice(n.length,e.length-s.length)];if(f.length!==e.length-s.length-l.length)throw Error(`Invalid turn step responses length: turnWithPromptStepResponses of ${f.length} should equal total steps (${e.length}) - before step (${l.length}) - after steps (${s.length}`);let y=e.slice(u.length+f.length);if(y.length!==s.length)throw Error(`Invalid after step responses length: params has ${s.length} after steps, response has ${y.length} after steps`);let m=[];u.forEach((e,t)=>{m.push({stepParams:l[t],stepResponse:e,turnId:"before"})});let g=(f.length-1)/d.length;if(g%1!=0)throw Error(`Invalid totalTurns length: turns in response (${f.length-1}) should be divisible by turns in params (${d.length})`);for(let e=0;e<g;e++)for(let t=0;t<d.length;t++){let n=f[e*d.length+t];if(!n)throw Error(`Invalid stepResponse: could not find response at turn [${e}], response [${t}]`);m.push({stepParams:d[t],stepResponse:n,turnId:e})}let T=f[f.length-1];if(!(T.type===i.InteractionStepType.MultiTurnContinue&&!T.context.shouldContinue))throw Error("Last step response must be MultiTurnContinue with shouldContinue set to false");return y.forEach((e,t)=>{m.push({stepParams:s[t],stepResponse:e,turnId:"after"})}),m.forEach(({stepParams:e,stepResponse:t},n)=>{if(e.type!==t.type&&!(e.type===i.InteractionStepType.PromptInput&&t.type===i.InteractionStepType.MultiTurnContinue))throw Error(`Invalid step response type at step index ${n}, param type ${e.type} does not match response type ${t.type}`)}),m}},112690:function(e,t){Object.defineProperty(t,"__esModule",{value:!0})},546112:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.populateAndValidateChatResponse=populateAndValidateChatResponse,t.maybeEnsureResponseSelfConsistency=maybeEnsureResponseSelfConsistency,t.maybePropagateResponseChanges=maybePropagateResponseChanges,t.extractPrefilledMessages=t.swapTurns=t.addTurn=t.duplicateTurn=t.deleteTurn=t.deleteAllTurnsAfterTurnIndex=t.reactivateSession=t.resetChatHistoryFromSelectedResponse=t.ensureStepResponseIndexConsistency=t.getMostRecentResponse=t.getMostRecentPrompt=t.interactionStepTriggersPropagation=t.ensureTextCollectionAnnotation=t.transformStepParamsToStepParamsWithStages=t.getStepParamsFromParams=t.getStepParamsForResponses=t.getNumTurns=t.populateTemplateAndPropagateChanges=t.validateChatResponse=t.validateStepTypes=t.stripTextCollectionResponses=void 0;var o=n(854358),a=n(954282),i=_interopRequireDefault(n(298784)),r=n(112738),s=n(108896),l=_interopRequireDefault(n(711719)),p=n(153115),d=n(530869),u=n(844159),c=n(900218);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}t.stripTextCollectionResponses=e=>e.map(e=>e.type===o.InteractionStepType.TextCollection?{...e,context:{...e.context,response:{annotations:{}}}}:e.type===o.InteractionStepType.TextCollectionPerResponse?{...e,context:{...e.context,annotations:{}}}:e);let validateChatResponseStep=(e,t)=>{if(t.contextType===o.ContextType.Skipped)return{valid:!0};switch(e.type){case o.InteractionStepType.PromptInput:case o.InteractionStepType.ModelResponseSelector:case o.InteractionStepType.ProcessSupervision:case o.InteractionStepType.ModelResponseEditor:break;case o.InteractionStepType.QuantitativeModelResponseSelector:case o.InteractionStepType.QualityMeasurement:case o.InteractionStepType.PromptTextCollection:case o.InteractionStepType.TextCollection:{let n=s.flattenFields(e.params.fields),{valid:o,message:a}=r.validateTextCollectionResponse(t.context.response,n);if(!o)return{valid:!1,message:a};break}case o.InteractionStepType.TextCollectionPerResponse:{let n=s.flattenFields(e.params.fields);for(let e of Object.keys(t.context.annotations)){let{valid:o,message:a}=r.validateTextCollectionResponse(t.context.annotations[e],n);if(!o)return{valid:!1,message:`Response ${e} is invalid: ${a}`}}break}case o.InteractionStepType.NER:{let e=t.context.response.annotations;for(let t of e){let e=d.annotationSchema.validate(t,{context:{textLength:1e6}})?.error;if(e)return{valid:!1,message:`Invalid NER annotation: ${JSON.stringify(t)}, ${e}`}}break}case o.InteractionStepType.MultiTurnContinue:case o.InteractionStepType.ContextDirections:break;case o.InteractionStepType.SearchAutoComplete:{let e=[...t.context.searchHistory,...t.context.additionalReferences];for(let t of e)if(p.searchResponseSchema.validate(t)?.error)return{valid:!1,message:`Invalid search response: ${JSON.stringify(t)}`}}}return{valid:!0}},validateStepTypes=(e,t)=>i.default.every(t,(t,n)=>t.type===e[n%e.length]);t.validateStepTypes=validateStepTypes;let validateBeforeSteps=(e,t,n)=>{let o=i.default.slice(t,0,e.before.length),a=validateStepTypes(e.before.map(e=>e.type),o);if(!a)return{valid:!1,message:"Invalid before steps"};if(n)for(let[t,n]of o.entries()){let o=e.before[t],{valid:a,message:i}=validateChatResponseStep(o,n);if(!a)return{valid:!1,message:`Step ${t+1} (${o.type}) is invalid: ${i}`}}return{valid:!0}},validateTurnSteps=(e,t,n)=>{let a=e.before.length,r=i.default.slice(t,a,t.length-e.after.length),s=r.length%(e.turn.length+1)==0;if(!s||e.turn.length>0&&0===r.length)return{valid:!1,message:`Invalid number of turns. Taxonomy has ${e.turn.length+1} turn steps but response has ${r.length} turn steps`};let l=validateStepTypes([...e.turn.map(e=>e.type),o.InteractionStepType.MultiTurnContinue],r);if(!l)return{valid:!1,message:"Invalid turn steps"};if(n){for(let[t,n]of r.entries())if(t%(e.turn.length+1)!==e.turn.length){let o=e.turn[t%(e.turn.length+1)],{valid:i,message:r}=validateChatResponseStep(o,n);if(!i)return{valid:!1,message:`Step ${a+t+1} (${o.type}) is invalid: ${r}`}}}return{valid:!0}},validateAfterSteps=(e,t,n)=>{let o=t.length-e.after.length,a=i.default.slice(t,o,t.length),r=validateStepTypes(e.after.map(e=>e.type),a);if(!r)return{valid:!1,message:"Invalid after steps"};if(n)for(let[t,n]of a.entries()){let a=e.after[t],{valid:i,message:r}=validateChatResponseStep(a,n);if(!i)return{valid:!1,message:`Step ${o+t} (${a.type}) is invalid: ${r}`}}return{valid:!0}},validateChatResponse=(e,t=[],n)=>{let{includePerResponseValidation:o}=n||{},a=validateBeforeSteps(e,t,o);if(!a.valid)return a;let i=validateTurnSteps(e,t,o);if(!i.valid)return i;let r=validateAfterSteps(e,t,o);if(!r.valid)return r;let{valid:s,message:l}=validateStepResponseIndexConsistency(t);return s?{valid:!0}:{valid:s,message:l}};t.validateChatResponse=validateChatResponse;let populateTemplateAndPropagateChanges=async(e,t,n,o)=>{let i=await a.populateTemplate({responses:t},n,{parseJson:!0,enabledCustomFilters:[a.CustomFilterTypes.minWith],includeTemplateVariables:o},{}),r=getStepParamsForResponses(e,i.responses);return i.responses.map((t,n)=>{maybeEnsureResponseSelfConsistency(r[n],i.responses[n]),maybePropagateResponseChanges(e,i.responses,n,{stopAtNextInteractionStepTrigger:!0}),i.responses[n].index=n}),i};async function populateAndValidateChatResponse(e,t,n,o){let a=await populateTemplateAndPropagateChanges(e,t,n,o),{valid:i,message:r}=validateChatResponse(e,a.responses,{includePerResponseValidation:!0});if(!i)throw Error(r);return a}t.populateTemplateAndPropagateChanges=populateTemplateAndPropagateChanges;let getNumTurns=(e,t)=>(t.length-e.before.length-e.after.length)/(e.turn.length+1);t.getNumTurns=getNumTurns;let getStepParamsForResponses=(e,t)=>{let n=getNumTurns(e,t);if(!i.default.isInteger(n))throw Error(`Number of responses (excluding before and after steps) is not a multiple of the expected number of the turns - found ${t.length} responses and but expected a multiple of ${e.turn.length+1}. This likely indicates a taxonomy mismatch.`);return getStepParamsFromParams(e,n)};t.getStepParamsForResponses=getStepParamsForResponses;let getStepParamsFromParams=(e,t)=>{let n=[...e.before,...i.default.flatMap(i.default.times(t,()=>[...e.turn,{id:l.default.v4(),type:o.InteractionStepType.MultiTurnContinue,params:{instructions:"Continue with the prompt or end your session."}}])),...e.after];return n};t.getStepParamsFromParams=getStepParamsFromParams,t.transformStepParamsToStepParamsWithStages=(e,t)=>{let n=[...(e.before??[]).map(e=>({...e,stage:u.ChatTaskParamsStages.Before,turn:-1})),...i.default.flatMap(i.default.times(t,()=>[...(e.turn??[]).map(e=>({...e,stage:u.ChatTaskParamsStages.Turn,turn:0})),{id:l.default.v4(),type:o.InteractionStepType.MultiTurnContinue,params:{instructions:"Continue with the prompt or end your session."},stage:u.ChatTaskParamsStages.Turn,turn:0}])),...(e.after??[]).map(e=>({...e,stage:u.ChatTaskParamsStages.After,turn:-1}))];return n.map((e,t)=>({...e,responseIndex:t}))};let ensureTextCollectionAnnotation=(e,t)=>{let n=s.flattenFields(e);Object.keys(t.annotations).map(e=>{t.annotations[e].field_id||(t.annotations[e].field_id=e),t.annotations[e].type||(t.annotations[e].type=n[e]?.type)})};function maybeEnsureResponseSelfConsistency(e,t){if(o.InteractionStepType.ModelResponseSelector===t.type){let{selectedIndex:e}=t.context;if(void 0===e)return;let n=t.context.candidates[e];void 0!==n&&(t.context.selectedId=n.id,t.output=n.message.content)}else o.InteractionStepType.TextCollection===t.type||o.InteractionStepType.QualityMeasurement===t.type?ensureTextCollectionAnnotation(e.params.fields,t.context.response):o.InteractionStepType.TextCollectionPerResponse===t.type&&Object.keys(t.context.annotations).map(n=>{ensureTextCollectionAnnotation(e.params.fields,t.context.annotations[n])})}t.ensureTextCollectionAnnotation=ensureTextCollectionAnnotation;let interactionStepTriggersPropagation=(e,t={})=>{if(e.contextType===o.ContextType.Skipped)return!1;let{previousStepResponse:n,stepParams:a,allStepResponses:i,benchmarkEdit:r,templateVariables:s,reviewLevel:l}=t;if(a&&i&&!c.isConditionallyVisible(a,i,e.index,s,l))return!1;let p=n&&n.output===e.output;return(!p||!!r)&&u.RESPONSE_GENERATOR_STEPS.includes(e.type)};function maybePropagateResponseChanges(e,t,n,a={stopAtNextInteractionStepTrigger:!1,benchmarkEdit:!1,templateVariables:{},reviewLevel:void 0}){let{stopAtNextInteractionStepTrigger:r,previousStepResponse:s,benchmarkEdit:l,templateVariables:p,reviewLevel:d}=a;if(!interactionStepTriggersPropagation(t[n],{previousStepResponse:s,benchmarkEdit:l,templateVariables:p,reviewLevel:d}))return;let u=new c.ChatHistory(e,{responses:t}),f=u.getFlattenedStepsWithResponses(),y=t[n].output;for(let e=n+1;e<f.length;e++){let[n,a]=f[e];if(!n||!a)break;if(n.type!==a.type)throw Error(`Mismatch between step type and response type at index ${e}: ${n.type} !== ${a.type}`);if(n.type===o.InteractionStepType.TextCollectionPerResponse){let n=getMostRecentResponseForStepType(t,e,o.InteractionStepType.ModelResponseSelector);n&&(a.context.candidates=i.default.cloneDeep(n.context.candidates),a.context.selectedId=n.context.selectedId)}if(a.type!==o.InteractionStepType.PromptInput){if(a.type===o.InteractionStepType.MultiTurnContinue){a.context.message=y;break}if(interactionStepTriggersPropagation(a,{stepParams:n,allStepResponses:t,templateVariables:p,reviewLevel:d})){if(r)break;if(a.type===o.InteractionStepType.ModelResponseEditor){var m,g;m=y,g=!!l,i.default.isEqual(a.context.originalText,m)||g||(a.context.originalText=m,a.context.baseResponse=m,a.output=m),y=a.output}else if(n.type===o.InteractionStepType.ModelResponseSelector&&a.type===o.InteractionStepType.ModelResponseSelector){let r=getMostRecentResponseForStepType(t,e,o.InteractionStepType.ModelResponseSelector);y=function(e,t,n,a){let{use_last_model_responses:r,use_existing_model_response_as_option:s,replace_last_selected_candidate_with_existing:l,always_send_given_id:p,skip_selection:d,include_all_responses_from_most_recent_response:u}=e.params;r&&a&&(t.context.candidates=i.default.cloneDeep(a.context.candidates));let c=t.context.candidates,f=i.default.keyBy(c,"id");s&&!u&&f[o.EXISTING_CANDIDATE_ID]&&updateExistingCandidateMessage(c,n,o.EXISTING_CANDIDATE_ID),s&&u&&a&&a.context.candidates.forEach(e=>{updateExistingCandidateMessage(c,e.message.content,e.id)});let y=a?.context.selectedId;l&&y&&y.length>0&&updateExistingCandidateMessage(c,n,y);let m=p&&p.length>0?p:t.context.selectedId;return m.length>0&&f[m]&&!i.default.isEqual(t.output,f[m].message.content)?t.output=f[m].message.content:d&&c.length>1&&(t.output=n),t.output}(n,a,y,r)}else if(n.type===o.InteractionStepType.ModelResponseRanking&&a.type===o.InteractionStepType.ModelResponseRanking){let r=getMostRecentResponseForStepType(t,e,o.InteractionStepType.ModelResponseSelector);y=function(e,t,n){if(!n)return t.output;let{always_send_given_id:o}=e.params,a=i.default.keyBy(i.default.cloneDeep(n.context.candidates),"id");t.context.rankedCandidates=t.context.rankedCandidates.map(e=>e.map(e=>a[e.id]));let r=t.context.rankedCandidates[0][0].message.content;return o&&a[o]&&(r=a[o].message.content),i.default.isEqual(t.output,r)||(t.output=r),t.output}(n,a,r)}else y=a.output}a.output=y}}}function getMostRecentResponseForStepType(e,t,n){return e.slice(0,t).filter(e=>e.type===n&&e.contextType!==o.ContextType.Skipped).at(-1)}function updateExistingCandidateMessage(e,t,n){let o=e.find(e=>e.id===n);o&&(o.message.content=t)}t.interactionStepTriggersPropagation=interactionStepTriggersPropagation,t.getMostRecentPrompt=(e,t)=>{let n=e.slice(0,t).filter(e=>e.type===o.InteractionStepType.PromptInput||e.type===o.InteractionStepType.MultiTurnContinue).at(-1);return n?.output},t.getMostRecentResponse=(e,t)=>{let n=e.slice(0,t).filter(e=>e.contextType!==o.ContextType.Skipped&&u.RESPONSE_GENERATOR_STEPS.includes(e.type)).at(-1);return n?.output};let computeMultiTurnContinueIndex=(e,t)=>e.before.length+e.turn.length+(t-1)*(e.turn.length+1),ensureStepResponseIndexConsistency=e=>{for(let t=0;t<e.length;t++)e[t].index=t};t.ensureStepResponseIndexConsistency=ensureStepResponseIndexConsistency;let validateStepResponseIndexConsistency=e=>{for(let t=0;t<e.length;t++)if(e[t].index!==t)return{valid:!1,message:`The response at index ${t} has index ${e[t].index} instead!`};return{valid:!0}};t.resetChatHistoryFromSelectedResponse=(e,t,n)=>{let a=n.index,r=t.slice(0,a),s=t.slice(a+1).find(e=>e.type===o.InteractionStepType.MultiTurnContinue),l=!i.default.isNil(s)&&s.context.shouldContinue,p=l?t.slice(a+1,s.index):t.slice(a+1),d=[...r,n,...p];return maybePropagateResponseChanges(e,d,a,{previousStepResponse:n}),d},t.reactivateSession=e=>{let t=e.filter(e=>e.type===o.InteractionStepType.MultiTurnContinue).at(-1)?.index;return i.default.isNil(t)?e:e.slice(0,t)},t.deleteAllTurnsAfterTurnIndex=(e,t,n)=>{let a=computeMultiTurnContinueIndex(t,n+1),r=i.default.cloneDeep(e),s=r.slice(0,a+1),l=[],p=e.filter(e=>e.type===o.InteractionStepType.MultiTurnContinue).at(-1);i.default.isNil(p)||p.context.shouldContinue||!(p.index<e.length-1)||(l=r.slice(p.index+1));let d=i.default.last(s);i.default.isNil(d)||(d.context.shouldContinue=!1,d.output="");let u=[...s,...l];return ensureStepResponseIndexConsistency(u),u},t.deleteTurn=(e,t,n)=>{let o=i.default.cloneDeep(e),a=computeMultiTurnContinueIndex(t,n),r=o.slice(0,a),s=o.slice(a+t.turn.length+1),l=o[a].context.message;s[0].context.message=l;let p=[...r,...s];return ensureStepResponseIndexConsistency(p),p},t.duplicateTurn=(e,t,n)=>{let o=computeMultiTurnContinueIndex(t,n),a=i.default.cloneDeep(e.slice(o,o+t.turn.length+1)),r=e.slice(0,o+t.turn.length+1),s=e.slice(o+t.turn.length+1),l=s[0].context.message;a[0].context.message=l;let p=[...r,...a,...s];return ensureStepResponseIndexConsistency(p),p},t.addTurn=(e,t,n)=>{let a=i.default.cloneDeep(e),r=computeMultiTurnContinueIndex(t,n+1),s=a.slice(0,r),p=a.slice(r),d=t.before.find(e=>e.type===o.InteractionStepType.PromptInput),u=d?.id??l.default.v4(),f={step_id:u,index:r,type:o.InteractionStepType.MultiTurnContinue,context:c.getNullContextForStepType(o.InteractionStepType.MultiTurnContinue),contextType:o.ContextType.Skipped,output:""},y=t.turn.map((e,t)=>{let n={type:e.type,context:c.getNullContextForStepType(e.type),contextType:o.ContextType.Skipped,output:""};return{...n,step_id:e.id,index:r+t+1}});p[0].context.message="";let m=[...s,f,...y,...p];ensureStepResponseIndexConsistency(m);let g=Object.fromEntries(Array.from({length:m.length},(e,n)=>n>=r&&n<r+t.turn.length+1?[n,!1]:[n,!0]));return{newResponses:m,newCompletedSteps:g}},t.swapTurns=(e,t,n)=>{let o=i.default.cloneDeep(e),a=computeMultiTurnContinueIndex(t,n),r=computeMultiTurnContinueIndex(t,n+1),s=o.slice(0,a),l=o.slice(r+t.turn.length+1),p=o.slice(a,r),d=o.slice(r,r+t.turn.length+1),u=p[0].context.message,c=d[0].context.message,f=l[0].context.message;d[0].context.message=u,p[0].context.message=f,l[0].context.message=c;let y=[...s,...d,...p,...l];return ensureStepResponseIndexConsistency(y),y},t.extractPrefilledMessages=e=>{if(!e)return{prevMessages:[],taskingUserMessages:[],taskingAssistantMessages:[]};let t=e?.findIndex(e=>e.role===o.MessageRole.User);if(-1===t)return{prevMessages:e,taskingUserMessages:[],taskingAssistantMessages:[]};let n=e.slice(0,t),a=e.slice(t),i=a.filter(e=>e.role===o.MessageRole.User),r=a.filter(e=>e.role===o.MessageRole.Assistant);return{prevMessages:n,taskingUserMessages:i,taskingAssistantMessages:r}}},844159:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.isTextCollectionStep=t.ChatTaskParamsStages=t.RESPONSE_GENERATOR_STEPS=void 0;var o,a,i=n(854358);let r=[i.InteractionStepType.QuantitativeModelResponseSelector,i.InteractionStepType.ModelResponseSelector,i.InteractionStepType.ModelResponseEditor,i.InteractionStepType.ModelResponseRanking,i.InteractionStepType.SearchAutoComplete,i.InteractionStepType.ProcessSupervision,i.InteractionStepType.ExperimentalToolUse,i.InteractionStepType.ToolUseProcessSupervision,i.InteractionStepType.SpanFeedback];t.RESPONSE_GENERATOR_STEPS=r,t.ChatTaskParamsStages=a,(o=a||(t.ChatTaskParamsStages=a={})).Before="before",o.Turn="turn",o.After="after",t.isTextCollectionStep=e=>[i.InteractionStepType.TextCollection,i.InteractionStepType.TextCollectionPerResponse,i.InteractionStepType.PromptTextCollection,i.InteractionStepType.ResponseTextCollection,i.InteractionStepType.QIRTextCollection,i.InteractionStepType.QualityMeasurement,i.InteractionStepType.QuantitativeModelResponseSelector].includes(e.type)},153115:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.searchResponseSchema=t.formatChatJoiValidateError=t.chatParamsSchema=t.interactionStepParamsSchema=t.TEMPLATE_VARIABLE_REGEX=void 0;var o,a=(o=n(39300))&&o.__esModule?o:{default:o},i=n(298784),r=n(974819),s=n(232095),l=n(167469),p=n(854358),d=n(276527);let u=/^\{\{ *?\w+ *?\}\}$/;t.TEMPLATE_VARIABLE_REGEX=u;let c=a.default.object().keys({id:a.default.string().required(),title:a.default.string().optional(),subtitle:a.default.string().allow("").optional(),params:a.default.object().optional(),override_id:a.default.boolean().optional()}).unknown(!0),f=a.default.object().keys({visibility_restricted:a.default.array().items(a.default.number()).optional(),editable_during_consensus:a.default.boolean().custom((e,t)=>{let{visibility_restricted:n=[]}=t.state.ancestors[0];return i.min(n)===l.ReviewLevel.ReviewConsensus||e}).optional()}).unknown(!0),y=a.default.object().keys({readonly_review_levels:a.default.array().items(a.default.number()).optional()}).unknown(!0),m=c.keys({type:a.default.string().valid(s.InteractionStepType.PromptInput).required(),params:f.keys({instructions:a.default.string().required(),display_type:a.default.string().valid(...Object.values(s.ChatMessageDisplayType)).optional()}).required()}),g=c.keys({type:a.default.string().valid(s.InteractionStepType.Instruction).required(),params:f.keys({instructions:a.default.string().required(),display_type:a.default.string().valid(...Object.values(s.ChatMessageDisplayType)).optional(),enable_rtl_text:a.default.boolean().optional(),initial_prompt_text:a.default.string().optional(),enableAudioRecording:a.default.boolean().optional(),generatePrompts:a.default.boolean().optional(),systemPromptForPromptGeneration:a.default.string().optional(),promptGenerationModel:a.default.string().optional()})}),T=c.keys({type:a.default.string().valid(s.InteractionStepType.ModelResponseSelector).required(),params:f.keys({chat_models:a.default.array().items(a.default.object().keys({id:a.default.string().required(),url:a.default.when("projectModelConfigurationKey",{is:a.default.exist(),then:a.default.string().optional(),otherwise:a.default.string().required()}),params:a.default.when("projectModelConfigurationKey",{is:a.default.exist(),then:a.default.object().optional(),otherwise:a.default.object().required()}),fallbackStrategy:a.default.string().optional(),fallbackEndpoint:a.default.object().keys({id:a.default.string().required(),url:a.default.string().required(),params:a.default.object().required()}).optional(),name:a.default.string().optional(),modelEndpointId:a.default.string().optional(),projectModelConfigurationKey:a.default.string().optional()})).custom((e,t)=>{let n=e.map(e=>e.id);return e&&i.uniq(n).length!==n.length?t.message({custom:'"Chat Models" must have unique ids.'}):e}),provided_model_responses:a.default.array().items(a.default.object().keys({id:a.default.string().required(),content:a.default.string().required()})).optional(),use_last_model_responses:a.default.boolean().custom((e,t)=>{let{chat_models:n=[],provided_model_responses:o=[]}=t.state.ancestors[0];return e&&(n.length>0||o.length>0)?t.message({custom:'"Chat Models" and "Provided Model Responses" must be empty when "Use Last Model Responses" is enabled.'}):e}).optional(),replace_last_selected_candidate_with_existing:a.default.boolean().custom((e,t)=>{let{use_last_model_responses:n}=t.state.ancestors[0];return e&&!n?t.message({custom:'"Replace Last Selected Candidate with Existing" can only be enabled when "Use Last Model Responses" is enabled.'}):e}).optional(),use_existing_model_response_as_option:a.default.boolean().optional(),include_all_responses_from_most_recent_response:a.default.boolean().optional(),skip_initial_messages:a.default.boolean().optional(),only_use_initial_messages_for_turn:a.default.boolean().optional(),force_consistent_responses:a.default.boolean().custom((e,t)=>{let{chat_models:n=[]}=t.state.ancestors[0];return e&&0===n.length?t.message({custom:'Live Chat Models must be provided when "Force Consistent Responses" is enabled.'}):e}).optional(),skip_selection:a.default.boolean().optional(),disable_selection:a.default.boolean().optional(),enable_selection_with_errors:a.default.boolean().optional(),max_model_response_errors_for_selection:a.default.number().optional(),allow_reroll:a.default.boolean().optional(),allow_reroll_for_reviewers_only:a.default.boolean().optional(),allow_reroll_for_individual_candidates:a.default.boolean().optional(),reset_history_on_change:a.default.boolean().optional(),always_send_given_id:a.default.string().optional(),show_likert_scale:a.default.boolean().optional(),max_likert:a.default.number().optional(),min_likert:a.default.number().optional(),custom_likert_labels:a.default.array().items(a.default.string()).optional(),show_objectivity:a.default.boolean().optional(),show_justification:a.default.boolean().optional(),enable_rtl_text:a.default.boolean().optional(),enable_model_critique:a.default.boolean().optional(),exclude_system_prompt:a.default.boolean().optional(),use_most_recent_output:a.default.boolean().optional(),use_first_initial_message:a.default.boolean().optional(),use_last_response_for_step_id:a.default.string().optional(),propagate_response_attachments:a.default.boolean().optional(),use_previous_turn_model_response_as_option:a.default.boolean().optional(),include_current_turn_in_chat_history:a.default.boolean().optional(),prompt_input_step_id_to_use_for_current_turn:a.default.string().optional(),enable_react_ui_rendering:a.default.boolean().optional(),extract_model_response_regex:a.default.string().optional(),enable_ui_generation:a.default.boolean().optional(),ui_generation_enforcement_mode:a.default.string().valid(...Object.values(p.UIGenerationEnforcementMode)).optional(),should_execute_tools:a.default.boolean().optional(),tool_parsing_params:a.default.object({toolIdRegex:a.default.string().optional(),toolInputRegex:a.default.string().optional(),toolOutputRegex:a.default.string().optional(),reconstructionTemplate:a.default.string().optional()}).optional(),omit_attachments:a.default.boolean().optional(),appended_system_prompt:a.default.string().optional(),appended_user_message:a.default.string().optional()}).required()}),S=c.keys({type:a.default.string().valid(s.InteractionStepType.ProcessSupervision,s.InteractionStepType.ExperimentalToolUse).required(),params:f.keys({use_sub_chunking_strategy:a.default.boolean().optional(),sub_chunking_strategy:a.default.string().optional(),sub_chunking_strategy_params:a.default.object().optional(),tools:a.default.array().items(a.default.string()).optional(),configId:a.default.string().optional(),isActionPlanEnabled:a.default.boolean().optional(),enable_manual_mark_as_complete:a.default.boolean().optional(),tool_ids:a.default.array().items(a.default.string()).optional(),do_not_include_finish_by_default:a.default.boolean().optional(),skip_observation:a.default.boolean().optional(),allow_tool_call_response_errors:a.default.boolean().optional(),allow_add_actions:a.default.boolean().optional(),allow_add_thought_and_action:a.default.boolean().optional(),allow_delete_actions:a.default.boolean().optional(),concatenateCodeFromPreviousSteps:a.default.boolean().optional(),tool_ids_via_template_variable:a.default.string().optional(),require_incorrect_rating:a.default.boolean().optional(),min_num_tools_used:a.default.number().optional(),modelName:a.default.string().optional(),can_edit_observation:a.default.string().optional(),run_tool_only_review_levels:a.default.array().items(a.default.number()).optional(),run_tool_only_incorrect_rating:a.default.boolean().optional(),process_chunking_strategy:a.default.string().optional(),process_chunking_strategy_params:a.default.object().optional(),re_request_model:a.default.boolean().optional(),end_after_rating_ids:a.default.array().items(a.default.any()).optional(),rating_buttons:a.default.array().items(a.default.object({value:a.default.alternatives().try(a.default.number(),a.default.string()).required(),label:a.default.string().required(),color:a.default.string().optional()})).optional(),fields_to_collect:a.default.array().items(a.default.object({fieldId:a.default.string().required(),label:a.default.string().required(),description:a.default.string().required(),collectForRatingValues:a.default.array().items(a.default.alternatives().try(a.default.number(),a.default.string()).required()).required(),required:a.default.boolean().required(),type:a.default.string().valid("markdown","plaintext","multiselect","select","latex").required(),options:a.default.array().items(a.default.object({value:a.default.string().required(),label:a.default.string().required()})).optional()})).optional(),min_negative_ratings:a.default.number().optional(),allow_skip:a.default.boolean().optional(),enable_edit_without_reroll:a.default.boolean().optional(),input_step_id:a.default.string().optional(),disable_edit_chunks:a.default.boolean().optional(),prerating_strategies:a.default.array().items(a.default.object()).optional(),enable_rtl_text:a.default.boolean().optional(),initial_input:a.default.string().optional(),initial_prompt:a.default.string().optional(),disable_manual_chunk_validation:a.default.boolean().optional(),output_first_bad_rating_only:a.default.boolean().optional(),remove_regex_matches:a.default.string().optional(),edit_chunks_title:a.default.string().optional(),enable_process_critique:a.default.boolean().optional(),process_critique_review_levels:a.default.array().items(a.default.number()).optional(),has_gtfa:a.default.boolean().optional(),limit_chat_history:a.default.boolean().optional(),remove_prompt_templating:a.default.boolean().optional(),custom_prompt_template:a.default.string().optional(),min_reflections_before_rewrite:a.default.number().optional()}).required()}),_=c.keys({type:a.default.string().valid(s.InteractionStepType.SearchAutoComplete).required(),params:f.keys({chat_models:a.default.array().items(a.default.object().keys({id:a.default.string().required(),url:a.default.string().required(),params:a.default.object().required(),name:a.default.string().optional()})).length(1),make_additional_references_optional:a.default.boolean().optional(),enable_rtl_text:a.default.boolean().optional()}).required()}),h=c.keys({type:a.default.string().valid(s.InteractionStepType.SearchReferences).required(),params:f.keys({chat_models:a.default.array().items(a.default.object().keys({id:a.default.string().required(),url:a.default.string().required(),params:a.default.object().required(),name:a.default.string().optional()})).length(1),enable_rtl_text:a.default.boolean().optional()}).required()}),b=c.keys({type:a.default.string().valid(s.InteractionStepType.ModelResponseEditor).required(),params:f.keys({enable_inline_comments:a.default.boolean().optional(),enable_rtl_text:a.default.boolean().optional(),termination_regex_condition:a.default.string().optional(),enable_executable_code_block:a.default.boolean().optional(),step_id_to_use_output_as_original_text:a.default.string().optional(),enable_react_ui_rendering:a.default.boolean().optional(),enable_ui_generation:a.default.boolean().optional(),ui_generation_enforcement_mode:a.default.string().valid(...Object.values(p.UIGenerationEnforcementMode)).optional()})}),I=c.keys({type:a.default.string().valid(s.InteractionStepType.TextCollection).required(),params:f.concat(y).keys({fields:a.default.array().items(r.unitFieldAlternativesSchema).required(),show_last_response:a.default.boolean().optional(),enable_inline_comments:a.default.boolean().optional(),prevent_retroactive_edits:a.default.boolean().optional(),reset_history_on_change:a.default.boolean().optional(),enable_rtl_text:a.default.boolean().optional(),save_as_system_message:a.default.boolean().optional()}).required()}),x=c.keys({type:a.default.string().valid(s.InteractionStepType.QualityMeasurement).required(),params:f.keys({fields:a.default.array().items(r.unitFieldAlternativesSchema).required(),enable_rtl_text:a.default.boolean().optional()}).required()}),v=c.keys({type:a.default.string().valid(s.InteractionStepType.TextCollectionPerResponse).required(),params:f.keys({chat_models:a.default.array().items(a.default.object().keys({id:a.default.string().required(),url:a.default.when("projectModelConfigurationKey",{is:a.default.exist(),then:a.default.string().optional(),otherwise:a.default.string().required()}),params:a.default.when("projectModelConfigurationKey",{is:a.default.exist(),then:a.default.object().optional(),otherwise:a.default.object().required()}),name:a.default.string().optional(),projectModelConfigurationKey:a.default.string().optional()})).custom((e,t)=>{let n=e.map(e=>e.id);return e&&i.uniq(n).length!==n.length?t.message({custom:'"Chat Models" must have unique ids.'}):e}).optional(),fields:a.default.array().items(r.unitFieldAlternativesSchema).required(),fieldToCheck:a.default.string().custom((e,t)=>{let{fields:n=[]}=t.state.ancestors[0];return n.some(t=>t.field_id===e)?e:t.message({custom:'"Ensure Ranking/Selection Consistency for the Given Field ID" in Text Collection Per-Response step must match a field id.'})}).optional(),enable_inline_comments:a.default.boolean().optional(),enable_rtl_text:a.default.boolean().optional(),enable_ui_generation:a.default.boolean().optional(),ui_generation_enforcement_mode:a.default.string().valid(...Object.values(p.UIGenerationEnforcementMode)).optional(),extract_model_response_regex:a.default.string().optional()}).required()}),R=c.keys({type:a.default.string().valid(s.InteractionStepType.NER).required(),params:f.keys({labels:a.default.array(),relationships:a.default.array().optional(),allow_overlapping_annotations:a.default.boolean().optional(),provided_text_step_id:a.default.string().optional(),provided_text_field_id:a.default.string().optional(),provided_model_id:a.default.string().optional(),enable_rtl_text:a.default.boolean().optional(),default_attribute_fields:a.default.object().optional()}).required()}),C=c.keys({type:a.default.string().valid(s.InteractionStepType.MultiTurnContinue).required(),params:f.keys({instructions:a.default.string().required(),enable_rtl_text:a.default.boolean().optional()}).required()}),k=c.keys({type:a.default.string().valid(s.InteractionStepType.ModelResponseRanking).required(),params:f.keys({always_send_given_id:a.default.string().optional(),enable_rtl_text:a.default.boolean().optional(),allow_ties:a.default.boolean().optional()}).required()}),w=c.keys({type:a.default.string().valid(s.InteractionStepType.QuantitativeModelResponseSelector).required(),params:f.keys({fields:a.default.array().items(r.unitFieldAlternativesSchema).required()}).required()}),M=c.keys({type:a.default.string().valid(s.InteractionStepType.ContextDirections).required(),params:f.keys({enable_rtl_text:a.default.boolean().optional()}).required()}),P=c.keys({type:a.default.string().valid(s.InteractionStepType.Voting).required(),params:f.keys({instructions:a.default.string().optional(),fields:a.default.array().items(r.unitFieldAlternativesSchema).required(),gtfaStepIds:a.default.array().items(a.default.string()).optional(),questionStepIds:a.default.array().items(a.default.string()).optional(),votingFieldIds:a.default.array().items(a.default.string()).optional(),sendToL11FieldId:a.default.string().optional(),newBlankReplicaFieldIds:a.default.array().items(a.default.string()).optional(),newBlankReplicaFieldId:a.default.string().optional(),prefillBlankReplicaStepIds:a.default.array().items(a.default.string()).optional(),blankReplicaOnlyCollectStepFieldIds:a.default.array().items(a.default.string()).optional(),votingConditions:a.default.object().pattern(a.default.string(),a.default.object().pattern(a.default.string(),a.default.array().items(a.default.object({matchReplicas:a.default.string().valid("all","any").required(),type:a.default.string().valid("exists","not exists").required(),fieldId:a.default.string().optional(),value:a.default.alternatives().try(a.default.string(),a.default.boolean(),a.default.number()).optional()})))).optional(),gtfaConditions:a.default.object().pattern(a.default.string(),a.default.object().pattern(a.default.string(),a.default.array().items(a.default.object({type:a.default.string().valid("exists","not exists").required(),fieldId:a.default.string().optional(),value:a.default.alternatives().try(a.default.string(),a.default.boolean(),a.default.number()).optional()})))).optional(),hideAllChoiceConditions:a.default.object().pattern(a.default.string(),a.default.object().pattern(a.default.string(),a.default.array().items(a.default.object({matchReplicas:a.default.string().valid("all","any").required(),type:a.default.string().valid("exists","not exists").required(),fieldId:a.default.string().optional(),value:a.default.alternatives().try(a.default.string(),a.default.boolean(),a.default.number()).optional()})))).optional(),showWinnerOnly:a.default.boolean().optional()}).required()}),E=a.default.object().keys({attachmentType:a.default.string().valid(...Object.values(p.AttachmentMetadataType)).required(),metadata:a.default.string().optional()}).unknown(!0),A=a.default.when(a.default.object({type:s.InteractionStepType.PromptInput}).unknown(),{then:m}).when(a.default.object({type:s.InteractionStepType.ModelResponseSelector}).unknown(),{then:T}).when(a.default.object({type:s.InteractionStepType.Instruction}).unknown(),{then:g}).when(a.default.object({type:s.InteractionStepType.ModelResponseEditor}).unknown(),{then:b}).when(a.default.object({type:s.InteractionStepType.ProcessSupervision}).unknown(),{then:S}).when(a.default.object({type:s.InteractionStepType.ExperimentalToolUse}).unknown(),{then:S}).when(a.default.object({type:s.InteractionStepType.TextCollection}).unknown(),{then:I}).when(a.default.object({type:s.InteractionStepType.QualityMeasurement}).unknown(),{then:x}).when(a.default.object({type:s.InteractionStepType.TextCollectionPerResponse}).unknown(),{then:v}).when(a.default.object({type:s.InteractionStepType.NER}).unknown(),{then:R}).when(a.default.object({type:s.InteractionStepType.MultiTurnContinue}).unknown(),{then:C}).when(a.default.object({type:s.InteractionStepType.ContextDirections}).unknown(),{then:M}).when(a.default.object({type:s.InteractionStepType.SearchAutoComplete}).unknown(),{then:_}).when(a.default.object({type:s.InteractionStepType.SearchReferences}).unknown(),{then:h}).when(a.default.object({type:s.InteractionStepType.ModelResponseRanking}).unknown(),{then:k}).when(a.default.object({type:s.InteractionStepType.QuantitativeModelResponseSelector}).unknown(),{then:w}).when(a.default.object({type:s.InteractionStepType.Voting}).unknown(),{then:P});t.interactionStepParamsSchema=A;let F=a.default.object().keys({role:a.default.string().custom((e,t)=>{let n=Object.values(s.MessageRole);return n.includes(e)||u.test(e)?e:t.message({custom:`Role must be one of ${n.join(", ")} or a template variable wrapped with {{}} such as {{TEMPLATE VARIABLE}}.`})}).required(),content:a.default.string().allow("").optional(),options:a.default.array().items(a.default.object().keys({id:a.default.string().required(),content:a.default.string().required(),modelEvalEndpointId:a.default.string().optional(),attachments:a.default.array().items(E).optional()})).optional(),userEditable:a.default.boolean().optional(),initialLikertScore:a.default.number().optional(),promptAttachments:a.default.array().optional()}).unknown(!0),O=a.default.object({format:a.default.string().default("wav").valid(...d.SUPPORTED_AUDIO_FORMATS),referenceAudioFile:a.default.string().optional(),maxVolume:a.default.number().min(-70).max(0).optional(),minAverageVolume:a.default.number().min(-70).max(0).optional(),maxAverageVolume:a.default.number().min(-70).max(0).optional(),maxAmbientNoiseVolume:a.default.number().min(-70).max(0).optional(),minBackgroundNoiseScore:a.default.number().optional(),minOverallSpeechScore:a.default.number().optional()}),L=a.default.object().keys({before:a.default.array().items(A).required(),turn:a.default.array().items(A).required(),after:a.default.array().items(A).required(),qir:a.default.array().max(1).items(A).optional(),minTurns:a.default.alternatives().try(a.default.number().integer().min(1).required(),a.default.string().regex(u).required()).required(),maxTurns:a.default.alternatives().try(a.default.number().integer().required(),a.default.string().regex(u).required()).required(),initialMessages:a.default.array().items(F).optional(),templateVariables:a.default.object().pattern(a.default.string(),a.default.string().allow("").optional()).optional(),hypothesis:a.default.object().optional(),useReferenceText:a.default.boolean().optional(),useReferenceTextOnMultiTurn:a.default.boolean().optional(),isReferenceTextRequired:a.default.boolean().optional(),hideReferenceURL:a.default.boolean().optional(),showReferenceCategory:a.default.boolean().optional(),allowSelectPdfAttachmentAsReferenceText:a.default.boolean().optional(),referenceTextCategories:a.default.string().optional(),requireReferenceTextOnlySingleTurn:a.default.boolean().optional(),minReferenceTexts:a.default.number().integer().min(0).optional(),maxReferenceTexts:a.default.number().integer().min(1).max(10).optional(),minReferenceTextsLength:a.default.number().integer().min(0).optional(),maxReferenceTextsLength:a.default.number().integer().min(1).max(1e7).optional(),isReferenceTextReadOnly:a.default.boolean().optional(),useAppendedReferenceText:a.default.boolean().optional(),useDefaultUserMessage:a.default.boolean().optional(),defaultUserMessageEditable:a.default.boolean().optional(),defaultUserMessage:a.default.string().optional().allow(""),usePreviousUserMessage:a.default.boolean().optional(),endSessionCondition:a.default.string().optional(),providedChatHistoryJson:a.default.string().optional(),enableSkipPromptInput:a.default.boolean().optional(),useAttachments:a.default.boolean().optional(),useAttachmentsOnMultiTurn:a.default.boolean().optional(),isAttachmentRequired:a.default.boolean().optional(),imageProvidedByCustomer:a.default.boolean().optional(),imageUrlTemplateVariable:a.default.string().optional(),disableImageEditing:a.default.boolean().optional(),useImageUrls:a.default.boolean().optional(),useImageUrlsOnMultiTurn:a.default.boolean().optional(),isImageUrlRequired:a.default.boolean().optional(),requireImageUrlsOnlySingleTurn:a.default.boolean().optional(),displayExecutedCode:a.default.boolean().optional(),minAttachments:a.default.number().integer().min(0).optional(),maxAttachments:a.default.number().integer().min(0).optional(),imageValidatorSettings:a.default.object().optional(),isDragAndDropDisabled:a.default.boolean().optional(),enableDownloadAttachments:a.default.boolean().optional(),enableMmImageService:a.default.boolean().optional(),allowNSFWImagesFromDB:a.default.boolean().optional(),audio:O.optional(),systemPrompt:a.default.string().optional().allow(""),systemPromptGptOnly:a.default.boolean().optional(),userPromptTemplate:a.default.string().optional().allow(""),restrictRollbacksInReview:a.default.boolean().optional(),enableLastTurnEditing:a.default.boolean().optional(),enableMassTurnDeletion:a.default.boolean().optional(),enableConversationEditing:a.default.boolean().optional(),forceHistoryReset:a.default.boolean().optional(),forceHistoryResetForResponseChanges:a.default.boolean().optional(),disablePromptEditing:a.default.boolean().optional(),resetChatHistoryOnEachTurn:a.default.boolean().optional(),passDownOriginalAttachments:a.default.boolean().optional(),isPromptGenerationEnabled:a.default.boolean().optional(),promptGenerationSystemPrompt:a.default.string().optional(),promptGenerationModel:a.default.string().optional(),isPreSeededPromptSuggestionEnabled:a.default.boolean().optional(),preSeededPromptSuggestions:a.default.string().optional(),specializations:a.default.string().optional().allow(""),workerSkills:a.default.string().optional().allow(""),turnLocking:a.default.boolean().optional(),renderCode:a.default.boolean().optional(),showHtmlGen:a.default.boolean().optional(),uiCodeGenerationLanguages:a.default.array().items(a.default.string().valid(...Object.values(p.UIGenerationLanguage))).optional(),codeRegex:a.default.string().optional(),maxProcessSupervisions:a.default.number().min(1).max(100).optional(),showMessageRoles:a.default.boolean().optional(),messageRoleOptions:a.default.array().items(a.default.string()).optional(),messageRolePromptInputHint:a.default.string().optional(),defaultExpand:a.default.boolean().optional(),messageForContributor:a.default.object().optional(),extractModelResponseRegex:a.default.string().optional(),allowedExtensions:a.default.array().items(a.default.string()).optional()}).unknown(!0);t.chatParamsSchema=L,t.formatChatJoiValidateError=(e,t)=>e.details.map(e=>{let n;let o=e.path.length>1,a=e.path[e.path.length-1];try{if("custom"===e.type)n=e.message;else if(o){let[o,r]=e.path,s=`${o}.${r}`,l=i.get(t,s),d=p.InteractionStepConfig[l.type]?.title;o&&"string"==typeof o||(o=""),"number"!=typeof r&&(r=parseInt(r));let u=e.message.replace(/"([^"]*)"/,`"${a}"`);n=`Error at: ${i.capitalize(o)} step number ${r+1} - ${d} - Field ${u}`}else n=`Field ${e.message}`}catch(t){n=e.message}return n});let N=a.default.object().keys({query:a.default.string().required(),snippet:a.default.string().required(),url:a.default.string().allow("",null).optional(),link:a.default.string().allow("",null).optional(),title:a.default.string().allow("",null).optional(),sourceTitle:a.default.string().allow("",null).optional(),isChecked:a.default.boolean().optional()}).unknown(!0),j=a.default.object().keys({searchTerm:a.default.string().required(),searchResults:a.default.array().items(N).required(),hasRunAutocomplete:a.default.boolean().optional()}).unknown(!0);t.searchResponseSchema=j},783768:function(e,t){var n,o,a,i,r,s,l,p,d,u;Object.defineProperty(t,"__esModule",{value:!0}),t.BackfillTaskOption=t.IneligibleReasonCategory=t.isBackfillError=t.TaxonomyConstant=t.BackfillTaskType=t.BackfillEligibility=t.ProjectArchetype=void 0,t.ProjectArchetype=n,(s=n||(t.ProjectArchetype=n={})).Eval="Eval",s.RLHF="RLHF",s.SFT="SFT",s.ProcessSupervision="Process Supervision",s.Unsupported="Unsupported",t.BackfillEligibility=o,(l=o||(t.BackfillEligibility=o={})).Eligible="Eligible",l.Ineligible="Ineligible",l.NotNeeded="Not Needed",l.Backfilled="Backfilled",l.DelayedBackfill="Delayed Backfill",t.BackfillTaskType=a,(p=a||(t.BackfillTaskType=a={})).TrainingScenario="Training Scenario",p.Task="Task",t.TaxonomyConstant={Eval:{PlaceholderStepId:{PromptInputPlaceholderForEmptyInitialQuestions:"placeholder-step-prompt-input"},StandardStepId:{Instruction:"instruction",Initial:"initial_questions",SideBySide:"side_by_side_questions",PerResponseRatings:"per_response_ratings",ReviewerFeedback:"reviewer_feedback"},StandardFieldId:{RejectReason:"reject_reason",PreferenceLikert:"preferenceLikert",RankingJustification:"ranking_reasoning",Objectivity:"objectivity",Accuracy:"accuracy",AccuracyDescription:"accuracy_description",ResponseTruthfulness:"response_truthfulness",ResponseIF:"response_if",ResponseInstructionFollowing:"response_instruction_following",InstructionFollowingDescription:"instruction_following_description",ResponseConcisenessRelevance:"response_conciseness_relevance",ResponseWritingStyleTone:"response_writing_style_tone",StyleAndTone:"style_and_tone",Truthfulness:"truthfulness",InstructionFollowing:"instruction_following",MainRequestAdherence:"main_request_adherence",ConstraintAdherence:"constraint_adherence",Grammar:"grammar",Relevance:"relevance",Verbosity:"verbosity",ResponseRelevance:"response_relevance",Depth:"depth",OverallScore:"overall_score",WritingQuality:"writing_quality",ToolLogCorrectness:"tool_log_correctness",ToolNamesCorrectness:"tool_names_correctness",ToolFunctionsCorrectness:"tool_functions_correctness",ToolParameterCorrectness:"tool_functions_parameter_correctness",Fulfillment:"fulfillment",ValidRejectReason:"valid_reject_reason",PreferenceAgreement:"preference_agreement",JustificationRating:"justification_rating",Feedback:"feedback"}},RLHF:{StandardStepId:{Prompt:"prompt",PostPromptQuestions:"post_prompt_questions",ResponsePreview:"response_preview",SideBySide:"side_by_side_questions",PerResponseRatings:"per_response_ratings",ModelResponseEditing:"model_response_editing",PostRewriteQuestions:"post_rewrite_questions",PostTurnQuestions:"post_turn_questions",ReviewerFeedback:"reviewer_feedback"},StandardFieldId:{RankingJustification:"ranking_reasoning",Accuracy:"accuracy",Completeness:"completeness",Fluency:"fluency",Grammar:"grammar",Localized:"localized",Format:"format",SelectedResponseIsGood:"selected_response_is_good",BetterResponseJustification:"better_response_justification",OverallScore:"overall_score",ValidRejectReason:"valid_reject_reason",PreferenceAgreement:"preference_agreement",JustificationRating:"justification_rating",Feedback:"feedback"}},SFT:{StandardStepId:{Prompt:"prompt",PostPromptQuestions:"post_prompt_questions",InitialUserResponse:"initial_user_response",PostResponseQuestions:"post_response_questions",ModelResponseComparison:"model_response_comparison",BetterResponseQuestions:"better_response_questions",PerResponseRatings:"per_response_ratings",ModelResponseEditing:"model_response_editing",PostRewriteQuestions:"post_rewrite_questions",PostTurnQuestions:"post_turn_questions",ReviewerFeedback:"reviewer_feedback"},StandardFieldId:{RankingJustification:"ranking_reasoning",Accuracy:"accuracy",Completeness:"completeness",Fluency:"fluency",Grammar:"grammar",Localized:"localized",Format:"format",SelectedResponseIsGood:"selected_response_is_good",BetterResponseJustification:"better_response_justification",OverallScore:"overall_score",RewriteExplanation:"rewrite_explanation",ValidRejectReason:"valid_reject_reason",PreferenceAgreement:"preference_agreement",JustificationRating:"justification_rating",Feedback:"feedback"}},ProcessSupervision:{StandardStepId:{Prompt:"prompt",PlanOfAction:"plan_of_action",IdealResponse:"ideal_response",ChainOfThought:"chain_of_thought"}}};let BackfillError=class BackfillError extends Error{constructor(e){super(e),this.name="BackfillError"}};t.BackfillError=BackfillError,t.isBackfillError=e=>e instanceof BackfillError,t.IneligibleReasonCategory=i,(d=i||(t.IneligibleReasonCategory=i={})).NoPipelineNode="NoPipelineNode",d.MissingTemplateVariables="MissingTemplateVariables",d.InvalidTaskParams="InvalidTaskParams",d.TaskUpToDate="TaskUpToDate",d.UnsafeBackfill="UnsafeBackfill",d.NoCorrespondingTask="NoCorrespondingTask",d.ChatModelsChanged="ChatModelsChanged",d.FieldsChanged="FieldsChanged",d.InvalidParamsChanges="InvalidParamsChanges",d.WarningParamsChanges="WarningParamsChanges",d.UnhandledStep="UnhandledStep",d.BadResponseFormat="BadResponseFormat",d.UnhandledField="UnhandledField",d.ReferenceModelsChanged="ReferenceModelsChanged",d.ResponseReferencesChanged="ResponseReferencesChanged",t.BackfillTaskOption=r,(u=r||(t.BackfillTaskOption=r={})).AttemptTask="Attempt (L-1) Task",u.ReviewTask="Review (L0) Task",u.AllOtherTasks="All Other Review Level Tasks (Not L-1, L0)",u.AttempterBenchmark="Attempter Benchmark",u.ReviewerBenchmark="Reviewer Benchmark"},530869:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.formatJoiValidateError=t.responseSchemaAny=t.annotationSchema=void 0;var o,a=(o=n(39300))&&o.__esModule?o:{default:o};let i=a.default.object().keys({selected:a.default.string().required()}),r=a.default.object().keys({id:a.default.string().required(),start:a.default.number().min(0).required(),end:a.default.number().greater(a.default.ref("start")).max(a.default.ref("$textLength")).required(),text:a.default.string().required(),label:a.default.string().required(),attributes:a.default.object().pattern(a.default.string(),i).optional()});t.annotationSchema=r;let s=a.default.object().keys({id:a.default.string().required(),source_ref:a.default.string().required(),target_ref:a.default.string().required(),name:a.default.string().optional()}),l=a.default.alternatives(a.default.string(),a.default.array().items(a.default.string()),a.default.number()),p=a.default.object().keys({annotations:a.default.array().items(r).unique("id").required(),relationships:a.default.array().items(s).unique("id").optional(),global_attributes:a.default.object().pattern(a.default.string(),l).optional()}),d=a.default.object().keys({annotations:a.default.array().items(r).unique("id").required(),relationships:a.default.array().allow(null).items(s).unique("id").optional(),global_attributes:a.default.object().pattern(a.default.string(),l).optional(),confidenceScore:a.default.number().allow(null).optional(),confidences:a.default.object().allow(null).unknown(!0).optional(),agreementScores:a.default.object().allow(null).unknown(!0).optional(),agreementScoreMean:a.default.number().allow(null).optional(),annotationConfidences:a.default.array().allow(null).items(a.default.number()).optional()}),u=a.default.alternatives().try(p,d);t.responseSchemaAny=u,t.formatJoiValidateError=e=>{let t=e.details[0],n=t.path.join(".");return`Invalid NER response, reason: ${t.message}, path: ${n}`}},954282:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.isDistributionItem=function(e){return"key"in e&&"weight"in e&&"fields"in e},t.convertMistParams=function(e,t){if(e){let n=u.default.cloneDeep(e);return convertPromptInputMinMaxWords(n,t),convertMinMaxTurns(n,t),n}return e},t.convertPromptInputMinMaxWords=convertPromptInputMinMaxWords,t.convertMinMaxTurns=convertMinMaxTurns,t.findUniqueChatModels=function findUniqueChatModels(e){let t=new Set;for(let n in e)if(Object.prototype.hasOwnProperty.call(e,n)){if("chat_models"===n&&Array.isArray(e[n]))e[n].forEach(e=>{e.params&&t.add(JSON.stringify({modelName:e.params.model,modelURL:e.url}))});else if("object"==typeof e[n]&&null!==e[n]){let o=findUniqueChatModels(e[n]);t=new Set([...t,...o])}}return t},t.findUniqueModelEndpointIds=function findUniqueModelEndpointIds(e){let t=new Set;for(let n in e)if(Object.prototype.hasOwnProperty.call(e,n)){if("chat_models"===n&&Array.isArray(e[n]))for(let o of e[n])o.modelEndpointId&&t.add(o.modelEndpointId);else if("object"==typeof e[n]&&null!==e[n]){let o=findUniqueModelEndpointIds(e[n]);t=new Set([...t,...o])}}return t},t.hasInvalidBrackets=function hasInvalidBrackets(e){return"string"==typeof e?/{{{|}}}/.test(e):Array.isArray(e)?e.some(e=>hasInvalidBrackets(e)):!!e&&"object"==typeof e&&Object.values(e).some(e=>hasInvalidBrackets(e))},t.BenchmarkArgFields=t.getSampledTask=t.getRowUniqueId=t.generateUniqueId=t.generateExpectedResponse=t.ACCEPTABLE_BM_FIELD_TYPES=t.parseChatModels=t.populateTemplateHelper=t.populateTemplate=t.CustomFilterTypes=void 0;var o,a,i,r,s,l=n(284040),p=n(108896),d=n(963494),u=(o=n(298784))&&o.__esModule?o:{default:o},c=n(854358),f=n(899047),y=n(153115);t.CustomFilterTypes=r,(a=r||(t.CustomFilterTypes=r={})).minWith="minWith",a.scaleTo="scaleTo";let m={minWith:(e,t)=>Math.min(e,t),scaleTo:(e,t,n,o,a)=>Math.round((a-o)*(e-t)/(n-t)+o)},populateTemplate=async(e,t,n,o={})=>{let{includeTemplateVariables:a=!0}=n||{},i=await populateTemplateHelper(e,t,n),r=u.default.isString(i)?JSON.parse(i):i;return a?{...r,templateVariables:t,templateVariablesConfiguration:o}:{...r}};t.populateTemplate=populateTemplate;let g=new l.Liquid({cache:!0}),populateTemplateHelper=async(e,t,n)=>{let{parseJson:o=!1,enabledCustomFilters:a=[],useCache:i=!1,strict:r=!1}=n||{},s=!i||a?.length||r?new l.Liquid({strictVariables:r}):g;for(let e of a)s.registerFilter(e,m[e]);if("string"==typeof e){let n=await s.parseAndRender(e,t);try{let t=RegExp("^{{ *?.* *?\\| *?toJson *?}}$","i");if(o||t.test(e))return JSON.parse(n);return n}catch(e){return n}}if(Array.isArray(e)){let o=await Promise.all(e.map(async e=>populateTemplateHelper(e,t,n)));return o}if("object"==typeof e&&null!==e){let o={};return await Promise.all(Object.keys(e).map(async a=>{o[a]=await populateTemplateHelper(e[a],t,n)})),o}return e};function validateSchemaForModel(e){let t=e.url;if(y.TEMPLATE_VARIABLE_REGEX.test(t))return;let n=f.StrategyParamsSchemaMap[f.masterEndpointMap[t].strategy];if(!n)throw Error(`No endpoint found for URL: ${t}`);let o=Object.fromEntries(Object.entries(e.params).filter(([,e])=>null!==e));try{n.parse(o)}catch(o){let t=o.issues[0].path.join("."),n=o.issues[0].message;throw Error(`Invalid endpoint configuration for ${e.id}: ${t} - ${n}`)}}t.populateTemplateHelper=populateTemplateHelper,t.parseChatModels=e=>{e&&e.turn&&e.turn.forEach(e=>{e.type===c.InteractionStepType.ModelResponseSelector&&e.params.chat_models?.forEach(e=>{e.projectModelConfigurationKey||(validateSchemaForModel(e),function(e){if(!u.default.isNil(e.fallbackEndpoint)&&(validateSchemaForModel(e.fallbackEndpoint),u.default.isEqual(u.default.pick(e,["url","params"]),u.default.pick(e.fallbackEndpoint,["url","params"]))))throw Error(`Fallback endpoint cannot be identical to ${e.id}`)}(e))})})};let T=[d.TextCollectionFieldType.Text,d.TextCollectionFieldType.Number,d.TextCollectionFieldType.TranscriptionText,d.TextCollectionFieldType.Category,d.TextCollectionFieldType.Boolean,d.TextCollectionFieldType.RankingOrder,d.TextCollectionFieldType.Autocomplete,d.TextCollectionFieldType.Select,d.TextCollectionFieldType.Code];t.ACCEPTABLE_BM_FIELD_TYPES=T,t.generateExpectedResponse=(e,t)=>{let n=getAnswersFromVariables(e,t);return p.createMiniformResponseForFields(n,t)};let getAnswersFromVariables=(e,t)=>{let n={};for(let o of t)switch(o.type){case d.TextCollectionFieldType.Text:case d.TextCollectionFieldType.Number:n[o.field_id]=[e[o.field_id]];break;case d.TextCollectionFieldType.RankingOrder:n[o.field_id]=JSON.parse(e[o.field_id]);break;case d.TextCollectionFieldType.Autocomplete:case d.TextCollectionFieldType.QueryableTextAndResults:case d.TextCollectionFieldType.JSON:case d.TextCollectionFieldType.Select:case d.TextCollectionFieldType.TranscriptionText:n[o.field_id]=[e[o.field_id]];break;case d.TextCollectionFieldType.Category:n[o.field_id]=[[...e[o.field_id].split(",").map(e=>e.trim())]];break;case d.TextCollectionFieldType.Boolean:n[o.field_id]=[!!e[o.field_id]];break;case d.TextCollectionFieldType.FieldSet:case d.TextCollectionFieldType.Form:Object.assign(n,getAnswersFromVariables(e,o.fields));break;case d.TextCollectionFieldType.Code:n[o.field_id]=[JSON.parse(e[o.field_id])];break;default:throw Error(`${o.type} is not compatible with the csv to benchmark tool`)}return n};function convertPromptInputMinMaxWords(e,t){for(let n of[...e.before,...e.turn,...e.after])if(n.type===c.InteractionStepType.PromptInput){if(void 0!==n.params.maxWords&&"string"==typeof n.params.maxWords){if(isNaN(parseInt(n.params.maxWords,10))){if(t.failOnParseInt)throw Error("Failed to parse maxWords");n.params.maxWords=987}else n.params.maxWords=parseInt(n.params.maxWords,10)}if(void 0!==n.params.minWords&&"string"==typeof n.params.minWords){if(isNaN(parseInt(n.params.minWords,10))){if(t.failOnParseInt)throw Error("Failed to parse minWords");n.params.minWords=1}else n.params.minWords=parseInt(n.params.minWords,10)}}}function convertMinMaxTurns(e,t){if(void 0!==e.minTurns&&"string"==typeof e.minTurns){if(isNaN(parseInt(e.minTurns,10))){if(t.failOnParseInt)throw Error("Failed to parse minTurns");e.minTurns=1}else e.minTurns=parseInt(e.minTurns,10)}if(void 0!==e.maxTurns&&"string"==typeof e.maxTurns){if(isNaN(parseInt(e.maxTurns,10))){if(t.failOnParseInt)throw Error("Failed to parse maxTurns");e.maxTurns=1}else e.maxTurns=parseInt(e.maxTurns,10)}}t.generateUniqueId=(e,t)=>`${e}_${t}`,t.getRowUniqueId=e=>e.split("_")[1],t.getSampledTask=e=>{if(e&&e.length>0){let t=[];for(let n of e)if(n&&n.length>0){if(n.every(e=>0===e.weight))throw Error("Distribution has all 0 weights");let e=u.default.sample(u.default.flatMap(n,e=>u.default.times(e.weight,()=>e)));e&&t.push({...e.fields,key:e.key})}else throw Error(`Distribution is not valid or empty: ${n}`);if(t.length>0){let e=u.default.reduce(t,(e,t)=>({...e,...t}),{});return e.key=t.map(e=>e.key).join("|"),e}return null}throw Error("Distributions are not valid or empty")},t.BenchmarkArgFields=s,(i=s||(t.BenchmarkArgFields=s={})).IsInstructive="is_instructive",i.BenchmarkFeedback="feedback",i.SceneConfigs="scene_configs",i.BenchmarkFeedbackV2="benchmark_feedback_v2",i.BenchmarkCandidate="benchmark_candidate",i.InstructionItems="instructionItems"},147460:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.PreviewAction=t.UnsupportedTaskReason=t.EmptyStepReason=t.NameToReviewLevelStrategyV2=t.NameToReviewLevelStrategy=t.ReviewLevelStrategyToNameV2=t.ReviewLevelStrategyToName=t.BackfillDecisionV2=t.BackfillDecision=t.ReviewLevelDecision=t.ReviewLevelOptionToReviewLevel=t.ReviewLevelToReviewLevelOption=t.ReviewLevelOption=t.ClaimStrategy=t.ReviewLevelStrategyV2=t.ReviewLevelStrategy=t.FetchBackfillQueryStatus=t.ValidationTypeLabels=t.ValidationType=void 0;var o,a,i,r,s,l,p,d,u,c,f,y,m,g,T,S,_,h,b,I,x,v,R,C,k=n(599789);t.ValidationType=m,(o=m||(t.ValidationType=m={})).CONTEXT_EMAILS="contextEmailsValidation",o.URL="urlValidation",o.JSON="jsonValidation";let w={[m.CONTEXT_EMAILS]:"Email Validation",[m.URL]:"URL Validation",[m.JSON]:"JSON Validation"};t.ValidationTypeLabels=w,t.FetchBackfillQueryStatus=g,(a=g||(t.FetchBackfillQueryStatus=g={}))[a.Success=0]="Success",a[a.Error=1]="Error",a[a.InProgress=2]="InProgress",t.ReviewLevelStrategy=T,(i=T||(t.ReviewLevelStrategy=T={}))[i.Stay=0]="Stay",i[i.Smart=1]="Smart",i[i.Restart=2]="Restart",t.ReviewLevelStrategyV2=S,(r=S||(t.ReviewLevelStrategyV2=S={})).Smart="Preserve work where possible",r.Restart="Restart from scratch",t.ClaimStrategy=_,(s=_||(t.ClaimStrategy=_={})).Preserve="Preserve contributor claims",s.Eject="Eject contributors",t.ReviewLevelOption=h,(l=h||(t.ReviewLevelOption=h={})).Unstarted="Unstarted",l.Attempt="Attempt",l.L0="L0",l.L1="L1",l.L4="L4",l.L8="L8",l.L10="L10",l.L11="L11",l.L12="L12";let M={[k.ReviewLevel.Attempt]:h.Attempt,[k.ReviewLevel.Normal]:h.L0,[k.ReviewLevel.Level1]:h.L1,[k.ReviewLevel.ReviewConsensus]:h.L4,[k.ReviewLevel.Expedite]:h.L8,[k.ReviewLevel.Corp]:h.L10,[k.ReviewLevel.CorpFlagged]:h.L11,[k.ReviewLevel.Deliverable]:h.L12};t.ReviewLevelToReviewLevelOption=M;let P={[h.Attempt]:k.ReviewLevel.Attempt,[h.L0]:k.ReviewLevel.Normal,[h.L1]:k.ReviewLevel.Level1,[h.L4]:k.ReviewLevel.ReviewConsensus,[h.L8]:k.ReviewLevel.Expedite,[h.L10]:k.ReviewLevel.Corp,[h.L11]:k.ReviewLevel.CorpFlagged,[h.L12]:k.ReviewLevel.Deliverable};t.ReviewLevelOptionToReviewLevel=P,t.ReviewLevelDecision=b,(p=b||(t.ReviewLevelDecision=b={}))[p.Stay=0]="Stay",p[p.Drop=1]="Drop",p[p.Restart=2]="Restart",t.BackfillDecision=I,(d=I||(t.BackfillDecision=I={})).OnlyParams="OnlyParams",d.CancelAndRedo="CancelAndRedo",d.ParamsAndResponse="ParamsAndResponse",t.BackfillDecisionV2=x,(u=x||(t.BackfillDecisionV2=x={})).RestartFromScratch="Restart (clear existing work)",u.PreserveWork="Preserve existing work",u.RestartUnstarted="Restart (task is unstarted)";let E={[T.Stay]:"Stay",[T.Restart]:"Restart",[T.Smart]:"Smart"};t.ReviewLevelStrategyToName=E;let A={[S.Restart]:"Restart from scratch",[S.Smart]:"Preserve work where possible"};t.ReviewLevelStrategyToNameV2=A;let F={Stay:T.Stay,Restart:T.Restart,Smart:T.Smart};t.NameToReviewLevelStrategy=F;let O={Restart:S.Restart,Smart:S.Smart};t.NameToReviewLevelStrategyV2=O,t.EmptyStepReason=v,(c=v||(t.EmptyStepReason=v={})).NewStep="This step is new",c.NewRequiredTurns="At least one new required turn was added",t.UnsupportedTaskReason=R,(f=R||(t.UnsupportedTaskReason=R={})).NoPrompt="The backfill tool only supports tasks that have a PromptInput step with a valid step_id",f.DuplicateStepId="The backfill tool does not support tasks with duplicate step ids (please fix this asap!!)",t.PreviewAction=C,(y=C||(t.PreviewAction=C={})).None="No, proceed as planned",y.Override="Yes, keep all tasks in their current level",y.Filter="Yes, filter out tasks that will move backward"},112738:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.collectUnexpectedFieldIds=collectUnexpectedFieldIds,t.validateTextCollectionResponse=function(e,t){for(let t of Object.values(e.annotations))if(s.annotationSchema.validate(t)?.error)return{valid:!1,message:`Invalid TextCollection annotation: ${t}`};let n=a.default.keyBy(i.flattenAnnotations(e.annotations),e=>e.field_id);delete n.rlhf_history;let o=collectUnexpectedFieldIds(t,n);if(0!==o.length)return{valid:!1,message:`Unexpected field ids: ${JSON.stringify(o)}`};for(let[e,o]of Object.entries(n)){let n=t[e],a=u[n.type]??DEFAULT_VALIDATION,{valid:i,message:r}=a({field:n,annotation:o});if(!i)return{valid:!1,message:`Invalid response for field id ${e}: ${r}`}}return{valid:!0}},t.getCategoricalValidChoices=getCategoricalValidChoices;var o,a=(o=n(298784))&&o.__esModule?o:{default:o},i=n(108896),r=n(963494),s=n(974819),l=n(689510),p=n(276527);function collectUnexpectedFieldIds(e,t){let n=Object.keys(e),o=Object.keys(t),a=o.filter(e=>!n.includes(e));return a}let validateBooleanOrNumberAnnotation=({field:e,annotation:t})=>{let{values:n}=i.getValidValuesForFieldId([e],e.field_id)??{};if(!n)return{valid:!0};e.type===r.TextCollectionFieldType.Number&&n.push(...n.filter(e=>a.default.isString(e)&&!a.default.isNaN(parseInt(e))).map(e=>parseInt(e)));let o=t.response[0],s=!a.default.isNil(o)&&""!==o&&!n.includes(o);return s?{valid:!1,message:`Unexpected choice: ${JSON.stringify(o)}`}:{valid:!0}},validateTextAnnotation=({field:e,annotation:t})=>{let n=t.response[0];return a.default.isNil(n)||a.default.isString(n)?{valid:!0}:{valid:!1,message:`Expected a string, but got ${JSON.stringify(n)}`}},d=l.z.object({type:l.z.literal(r.TextCollectionFieldType.AudioRecording),format:l.z.enum(p.SUPPORTED_AUDIO_FORMATS).optional().default("webm"),referenceAudioFile:l.z.string().optional(),minAudioDuration:l.z.number().min(0).optional(),maxAudioDuration:l.z.number().min(1).optional(),maxVolume:l.z.number().min(-70).max(0).optional(),minAverageVolume:l.z.number().min(-70).max(0).optional(),maxAverageVolume:l.z.number().min(-70).max(0).optional(),maxAmbientNoiseVolume:l.z.number().min(-70).max(0).optional(),minBackgroundNoiseScore:l.z.number().optional(),minOverallSpeechScore:l.z.number().optional(),disableRecording:l.z.boolean().optional()}),DEFAULT_VALIDATION=({field:e,annotation:t})=>({valid:!0}),u={[r.TextCollectionFieldType.Text]:validateTextAnnotation,[r.TextCollectionFieldType.TranscriptionText]:DEFAULT_VALIDATION,[r.TextCollectionFieldType.Boolean]:validateBooleanOrNumberAnnotation,[r.TextCollectionFieldType.Number]:validateBooleanOrNumberAnnotation,[r.TextCollectionFieldType.Datetime]:DEFAULT_VALIDATION,[r.TextCollectionFieldType.Category]:({field:e,annotation:t})=>{if(e.choicesS3Artifact)return{valid:!0};let n=a.default.get(e,"can_select_intermediate_nodes")||!1,o=getCategoricalValidChoices([e],n),i=a.default.flatten(Object.values(o)).map(e=>e.toString());if(a.default.some(t.response,e=>!a.default.isArray(e)&&""!==e))return{valid:!1,message:`Invalid response: ${JSON.stringify(t.response)}`};let r=a.default.flatten(t.response).map(e=>e.toString()).filter(e=>""!==e),s=r.filter(e=>!i.includes(e));return 0!==s.length?{valid:!1,message:`Unexpected choices: ${JSON.stringify(s)}`}:{valid:!0}},[r.TextCollectionFieldType.FieldSet]:DEFAULT_VALIDATION,[r.TextCollectionFieldType.TimeRange]:DEFAULT_VALIDATION,[r.TextCollectionFieldType.Select]:DEFAULT_VALIDATION,[r.TextCollectionFieldType.Form]:DEFAULT_VALIDATION,[r.TextCollectionFieldType.BoundingBox]:DEFAULT_VALIDATION,[r.TextCollectionFieldType.Autocomplete]:DEFAULT_VALIDATION,[r.TextCollectionFieldType.RankingOrder]:DEFAULT_VALIDATION,[r.TextCollectionFieldType.RLHFHistory]:DEFAULT_VALIDATION,[r.TextCollectionFieldType.Code]:DEFAULT_VALIDATION,[r.TextCollectionFieldType.FileUpload]:DEFAULT_VALIDATION,[r.TextCollectionFieldType.QueryableTextAndResults]:DEFAULT_VALIDATION,[r.TextCollectionFieldType.JSON]:DEFAULT_VALIDATION,[r.TextCollectionFieldType.WorkspaceContainer]:DEFAULT_VALIDATION,[r.TextCollectionFieldType.WfeButton]:DEFAULT_VALIDATION,[r.TextCollectionFieldType.Markdown]:validateTextAnnotation,[r.TextCollectionFieldType.Tool]:DEFAULT_VALIDATION,[r.TextCollectionFieldType.Instruction]:DEFAULT_VALIDATION,[r.TextCollectionFieldType.Rubric]:DEFAULT_VALIDATION,[r.TextCollectionFieldType.AudioRecording]:({field:e,annotation:t})=>{let n=d.safeParse(e);if(!n.success)return{valid:!1,message:`Invalid AudioRecording field: ${JSON.stringify(n.error)}`};if(t.type!==r.TextCollectionFieldType.AudioRecording)return{valid:!1,message:`Expected AudioRecording annotation, but got ${t.type}`};let{format:o}=n.data;return t.response.some(e=>e.mimeType!==`audio/${o}`)?{valid:!1,message:"Invalid mimeType in response"}:{valid:!0}},[r.TextCollectionFieldType.MultiChannelAudioUpload]:DEFAULT_VALIDATION,[r.TextCollectionFieldType.DynamicLabeledText]:DEFAULT_VALIDATION,[r.TextCollectionFieldType.AttachmentUpload]:DEFAULT_VALIDATION,[r.TextCollectionFieldType.MultiPartText]:DEFAULT_VALIDATION};function getCategoricalValidChoices(e,t){let flattenChoiceTree=e=>{let n=[];return e.forEach(e=>{e.subchoices?(n=n.concat(flattenChoiceTree(e.subchoices)),t&&n.push(e.value)):n.push(e.value)}),n},n={},traverseFields=e=>{for(let t of e)if(t.type===r.TextCollectionFieldType.FieldSet||t.type===r.TextCollectionFieldType.Form)traverseFields(t.fields);else if(t.type===r.TextCollectionFieldType.Category){let e=t.choices;n[t.field_id]=flattenChoiceTree(e)}else t.type===r.TextCollectionFieldType.Select&&(n[t.field_id]=t.choices||[])};return traverseFields(e),n}}}]);