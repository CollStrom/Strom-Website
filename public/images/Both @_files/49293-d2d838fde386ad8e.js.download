"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[49293],{513473:function(e,t,n){t.Hm=void 0;var i,r=n(854358),o=n(963494),l=n(673793),a=(i=n(298784))&&i.__esModule?i:{default:i},s=n(810755);let d="__FIELD_ID_DELIMITER__/";function _getTextCollectionResponse(e){if(!e)return;let t={annotations:{}};for(let n of e.responses){let e=n.index;if(n.contextType!==r.ContextType.Skipped&&(n.type===r.InteractionStepType.TextCollection||n.type===r.InteractionStepType.QualityMeasurement)){let i=a.default.fromPairs(Object.entries(n.context.response.annotations).filter(([e,t])=>t.type!==o.TextCollectionFieldType.FieldSet).map(([t,i])=>{let r=`${e}/${d}${t}`,o={...i,field_id:r,chatTaskAnnotationMetadata:{stepId:n.step_id,responseIndex:e,originalFieldId:t}};return[r,o]}));Object.assign(t.annotations,i)}}return t}function _getTextCollectionPerResponseResponse(e){if(!e)return;let t={annotations:{}};for(let n of e.responses){let e=n.index;n.type===r.InteractionStepType.TextCollectionPerResponse&&Object.entries(n.context.annotations).forEach(([i,r])=>{let l=n.context.candidates.find(e=>e.id===i)?.index??-1,s=a.default.fromPairs(Object.entries(r.annotations).filter(([e,t])=>t.type!==o.TextCollectionFieldType.FieldSet).map(([t,i])=>{let r=`${e}/${l}/${d}${t}`,o={...i,field_id:r,chatTaskAnnotationMetadata:{stepId:n.step_id,responseIndex:e,candidateIndex:l,originalFieldId:t}};return[r,o]}));Object.assign(t.annotations,s)})}return t}t.Hm=e=>{if(e){switch(e.chatGraderAnnotationType){case"textcollection":return e.response?.[0]?.given;case"namedentityrecognition":return e.text;case"model-response-selector":return getAnnotationValueMRS(e);case"processsupervision":return e.rating;case"model-response-ranking":return e.rankings}if(e.response)return e.response}};let getAnnotationValueMRS=e=>{if(!e||-1===e.selectedIndex)return;let t=void 0!==e.likertValueRaw?`, Score: ${e.likertValueRaw}`:"",n=void 0!==e.selectedIndex?`Response ${e.selectedIndex+1}`:e.selectedId;return`${n}${t}`}},952302:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.getTextCollectionGraderDiffResponse=t.getFieldDefinitionsWithFieldSet=t.getFieldDefinitions=t.matchFieldSetResponseArray=t.compareFieldSet=t.compareFieldSets=t.compareUnitField=t.compareUnitFields=void 0;var i=_interopRequireDefault(n(298784)),r=n(222357),o=n(889794),l=n(963494),a=n(934788),s=_interopRequireDefault(n(952256)),d=n(764848),u=n(918397);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}let p=["name"],c=["option_name","item_name"],f=["category_menu_hours"],getRepresentativeValue=e=>{let t=i.default.sortBy(Object.entries(e),"field_id");for(let[e,n]of t)if(n.type===l.TextCollectionFieldType.Text&&i.default.some(p,t=>e.toLowerCase().endsWith(t)))return i.default.sortBy(n.response).join("-");let[,n]=t[0];return getPrimitiveResponse(n).join("-")},getPrimitiveResponse=e=>{if(e.type===l.TextCollectionFieldType.FieldSet)return e.response.map(e=>getRepresentativeValue(e));if(e.type===l.TextCollectionFieldType.Datetime){let t=i.default.sortBy(e.response,["year","month","day","hour","minute"]);return t.map(e=>`${e.year}-${e.month}-${e.day}-${e.hour}-${e.minute}`)}{let t=i.default.sortBy(e.response);return t.map(e=>String(e))}},getMatchDistance=(e,t,n=!1,r=!1,o=!1)=>{if(r)return 1-+n;let l=Object.entries(t),a=l.length;if(0===a)return 1;let s=0,d=0,u=[];s=compareUnitFields(e,t),u.push(s),o&&(d=compareFieldSets(e,t),u.push(d));let p=i.default.mean(u);return p-.2*+n},compareUnitFields=(e,t)=>{let n=0,r=0,l=0,a=0,s=[];for(let d of(i.default.map(t,(e,t)=>{o.isUnitFieldAnnotation(e)&&!f.includes(t)&&s.push(t)}),s)){let i=t[d],o=e[d];if(void 0===o)continue;let{distance:s,maxDistance:u,isName:p,noCriticalOverlap:c}=compareUnitField(o,i);if(p&&c)return 10;p?(n=s,r=u):(l+=s,a=u)}let d=a?l/a:0,u=r?n/r:0;return a&&r?i.default.mean([u,d]):a?d:r?u:0};t.compareUnitFields=compareUnitFields;let compareUnitField=(e,t)=>{let n=0,r=0,o=!1,u=t.type===l.TextCollectionFieldType.Text&&i.default.some(p,e=>t.field_id.toLowerCase().endsWith(e));if(u){let i=e.response?.[0]||"",l=t.response?.[0]||"",a=i?.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""),u=l?.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");if(c.includes(t.field_id)){let e=d.gradeFreeText(a,u,d.TextComparisonMethod.TokenIOU);o=!!e.totalWork&&0===e.correctWork}let p=s.default(a,u);n=p/Math.max(a.length,u.length),r=1}else{let i=getPrimitiveResponse(t),o=getPrimitiveResponse(e);.5>a.redundantIou(i,o)&&(n=1),r=1}return{distance:n,maxDistance:r,isName:u,noCriticalOverlap:o}};t.compareUnitField=compareUnitField;let compareFieldSets=(e,t)=>{let n=0,r=0,l=[];return i.default.map(t,(e,t)=>{o.isFieldSetAnnotation(e)&&l.push(t)}),i.default.map(l,i=>{let o=t[i],l=e[i];if(void 0===l||0===o.response.length)return;let{distance:a,maxDistance:s}=compareFieldSet(l,o);n+=a,r+=s}),r?n/r:0};t.compareFieldSets=compareFieldSets;let compareFieldSet=(e,t)=>{let n=matchFieldSetResponseArray(e.response,t.response),r=i.default.filter(n,e=>!!e.givenAnnotation&&!!e.expectedAnnotation),o=i.default.filter(n,e=>!e.givenAnnotation),l=r.length/(r.length+o.length);return{distance:1-l,maxDistance:1}};t.compareFieldSet=compareFieldSet;let matchFieldSetResponseArray=(e,t,n,r,o,l)=>{let a=[],s=i.default.cloneDeep(e);if(1===e.length&&1===t.length)return[{givenAnnotation:e[0],expectedAnnotation:t[0]}];let d=i.default.flatten(s.map((e,i)=>t.map((t,a)=>{let s=!!n?.[i]&&n?.[i]===r?.[a],d=getMatchDistance(e,t,s,!!o,!!l);return{i,j:a,distance:d}}))),u=i.default.sortBy(d,"distance"),p={},c={};u.forEach(({i:e,j:t,distance:n})=>{if(e in p||t in c||n>.7)return;let i={distance:n};p[e]={idx:t,metadata:i},c[t]={idx:e,metadata:i}});let f=[];for(let e of(t.map((e,t)=>{let n=c?.[t]?.idx;if(void 0!==n){let t=s[n];f.push(n),a.push({givenAnnotation:t,expectedAnnotation:e})}else a.push({givenAnnotation:void 0,expectedAnnotation:e})}),i.default.pullAt(s,f),s))a.push({givenAnnotation:e,expectedAnnotation:void 0});return a};t.matchFieldSetResponseArray=matchFieldSetResponseArray;let matchAnnotationMap=(e,t)=>{if(void 0===e&&void 0===t)return{missingAnnotations:{},extraneousAnnotations:{},matchedAnnotations:{}};if(void 0===e)return{missingAnnotations:t,extraneousAnnotations:{},matchedAnnotations:{}};if(void 0===t)return{missingAnnotations:{},extraneousAnnotations:e,matchedAnnotations:{}};{let n=Object.keys(e),i=Object.keys(t),r={},o={},l={};for(let r of a.redundantIntersection(n,i))l[r]={expectedAnnotation:t[r],givenAnnotation:e[r]};for(let t of a.redundantDifference(n,i))o[t]=e[t];for(let e of a.redundantDifference(i,n))r[e]=t[e];return{missingAnnotations:r,extraneousAnnotations:o,matchedAnnotations:l}}},getNonMatchedGraderAnnot=(e,t,n)=>{let i=[];if(o.isFieldSetAnnotation(e))for(let o of e.response){let e={};for(let[i,r]of Object.entries(o))e[i]=getNonMatchedGraderAnnot(r,t,n);t===r.GraderResult.Extraneous?i.push({result:t,given:e}):i.push({result:t,expected:e})}else for(let n of e.response)t===r.GraderResult.Extraneous?i.push({result:t,given:n}):i.push({result:t,expected:n});let a=e.type===l.TextCollectionFieldType.AttachmentUpload?{type:e.type,field_id:e.field_id,response:i}:e.type===l.TextCollectionFieldType.TranscriptionText?{field_id:e.field_id,type:e.type,response:i,tags:e.tags}:(e.type,l.TextCollectionFieldType.MultiPartText,{field_id:e.field_id,type:e.type,response:i});return e.fieldWasReadOnly&&(a.fieldWasReadOnly=e.fieldWasReadOnly),e.chatTaskAnnotationMetadata&&(a.chatTaskAnnotationMetadata=e.chatTaskAnnotationMetadata),populateCategoryMetadata(a,n),a},getMatchedFieldSetGraderAnnot=(e,t,n)=>{let i=[],o=matchFieldSetResponseArray(e.response,t.response,e.uuids,t.uuids,n?.context?.useOnlyUuids,!0);for(let e of o){let t=e.givenAnnotation,o=e.expectedAnnotation,l=convertToGraderAnnotation(t,o,n);void 0===t?i.push({result:r.GraderResult.Missing,expected:l}):void 0===o?i.push({result:r.GraderResult.Extraneous,given:l}):i.push({result:r.GraderResult.Matched,given:l,hasCorrectChildren:!0})}return{field_id:t.field_id,type:l.TextCollectionFieldType.FieldSet,response:i}},normalizeTextResponse=e=>e.map(e=>(e??"").trim().replace(/\s+/g," ")),getMatchedUnitGraderAnnot=(e,t)=>{let n=[],i=e.type===l.TextCollectionFieldType.Text||e.type===l.TextCollectionFieldType.Autocomplete?normalizeTextResponse(e.response):e.response,o=t.type===l.TextCollectionFieldType.Text||t.type===l.TextCollectionFieldType.Autocomplete?normalizeTextResponse(t.response):t.response;for(let e of a.redundantIntersection(i,o))n.push({result:r.GraderResult.Correct,given:e});let s=a.redundantDifference(o,i),d=a.redundantDifference(i,o),u=Math.min(s.length,d.length);for(let e=0;e<u;++e)n.push({result:r.GraderResult.Incorrect,given:d[e],expected:s[e]});s.slice(u).forEach(e=>n.push({result:r.GraderResult.Missing,expected:e})),d.slice(u).forEach(e=>n.push({result:r.GraderResult.Extraneous,given:e}));let p=t.type===l.TextCollectionFieldType.TranscriptionText?{field_id:t.field_id,type:t.type,response:n,tags:t.tags}:{field_id:t.field_id,type:t.type,response:n};return t.fieldWasReadOnly&&(p.fieldWasReadOnly=t.fieldWasReadOnly),e.chatTaskAnnotationMetadata&&(p.chatTaskAnnotationMetadata=e.chatTaskAnnotationMetadata),p},getMatchedGraderAnnot=(e,t,n)=>{if(o.isFieldSetAnnotation(t))return getMatchedFieldSetGraderAnnot(e,t,n);if(!o.isUnitFieldAnnotation(t))return{field_id:"rlhf_history",type:t.type,response:[]};{let i=getMatchedUnitGraderAnnot(e,t);return populateCategoryMetadata(i,n.fieldDefinitions),i}},populateCategoryMetadata=(e,t)=>{if(e.type===l.TextCollectionFieldType.Category&&t[e.field_id]){let n=t[e.field_id];for(let t of e.response)t.categoryMetadata={given:{},expected:{}},(t.result===r.GraderResult.Correct||t.result===r.GraderResult.Incorrect||t.result===r.GraderResult.Extraneous)&&(t.categoryMetadata.given=u.getAllCategoryFullPathLabels(n.choices,t.given)),(t.result===r.GraderResult.Missing||t.result===r.GraderResult.Incorrect)&&(t.categoryMetadata.expected=u.getAllCategoryFullPathLabels(n.choices,t.expected))}},filterAnnotations=(e,t)=>{switch(t){case"all_fields":return e;case"no_field":return{};default:return i.default.fromPairs(Object.entries(e).filter(([e])=>t.includes(e)))}},convertToGraderAnnotation=(e,t,n)=>{let{matchedAnnotations:i,missingAnnotations:o,extraneousAnnotations:l}=matchAnnotationMap(e,t),a={};return Object.entries(filterAnnotations(i,n.fieldFilter)).forEach(([e,{givenAnnotation:t,expectedAnnotation:i}])=>a[e]=getMatchedGraderAnnot(t,i,n)),Object.entries(filterAnnotations(l,n.fieldFilter)).forEach(([e,t])=>a[e]=getNonMatchedGraderAnnot(t,r.GraderResult.Extraneous,n.fieldDefinitions)),Object.entries(filterAnnotations(o,n.fieldFilter)).forEach(([e,t])=>a[e]=getNonMatchedGraderAnnot(t,r.GraderResult.Missing,n.fieldDefinitions)),a},updateFieldSetCorrectnessFlag=e=>{let t=!0;for(let[,n]of Object.entries(e))if(r.isFieldSetGraderAnnotation(n)){let e=!0;for(let t of n.response)t.result===r.GraderResult.Matched?(t.hasCorrectChildren=updateFieldSetCorrectnessFlag(t.given),e=e&&t.hasCorrectChildren):e=!1;t=t&&e}else t=t&&n.response.every(e=>e.result===r.GraderResult.Correct);return t},getFieldDefinitions=e=>{let t={};for(let n of e)if(n.type===l.TextCollectionFieldType.FieldSet||n.type===l.TextCollectionFieldType.Form){let e=getFieldDefinitions(n.fields);for(let[n,i]of Object.entries(e))t[n]=i}else t[n.field_id]=n;return t};t.getFieldDefinitions=getFieldDefinitions;let getFieldDefinitionsWithFieldSet=e=>{let t={};for(let n of e)if(n.type===l.TextCollectionFieldType.Form){let e=getFieldDefinitionsWithFieldSet(n.fields);for(let[n,i]of Object.entries(e))t[n]=i}else t[n.field_id]=n;return t};t.getFieldDefinitionsWithFieldSet=getFieldDefinitionsWithFieldSet;let getFieldFilter=e=>0===e.length?"all_fields":e;t.getTextCollectionGraderDiffResponse=(e,t,n)=>{let i={fieldDefinitions:getFieldDefinitions(n?.taskFields||[]),fieldFilter:getFieldFilter(n?.fieldsWhitelist||[]),context:n},r=convertToGraderAnnotation(e.annotations,t.annotations,i);return updateFieldSetCorrectnessFlag(r),{annotations:r}}},673793:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.textCollectionTransformFn=void 0;var i,r=(i=n(298784))&&i.__esModule?i:{default:i},o=n(952302),l=n(963494),a=n(222357);let getGraderAnnotation=(e,t,n,i,o,s,d)=>{if(n.type===l.TextCollectionFieldType.RLHFHistory)return[];if(n.type!==l.TextCollectionFieldType.FieldSet)return[{props:{label:e,id:t,parentGiven:s,grandParentGiven:d,textCollectionFieldType:n.type},frames:{0:n}}];let u=[];return n.response.forEach((e,n)=>{let l=[],d=e.result===a.GraderResult.Matched;e.result===a.GraderResult.Matched||e.result===a.GraderResult.Extraneous?l=Object.entries(e.given):e.result===a.GraderResult.Missing&&(l=Object.entries(e.expected));let p=r.default.flatMap(l,([e,r])=>{let l=`${t}/${n}/${e}`;return getGraderAnnotation(e,l,r,i,o,d,s)});u.push(...p)}),u},getGraderAnnotations=async(e,t)=>r.default.flatMap(Object.entries(e.annotations),([e,n],i)=>getGraderAnnotation(e,e,n,i,t,!0,!0)),textCollectionTransformFn=async(e,t,n,i)=>{if(!e)return[];let l=i||r.default.cloneDeep(e),a=o.getTextCollectionGraderDiffResponse(e,l,n);return getGraderAnnotations(a,t)};t.textCollectionTransformFn=textCollectionTransformFn},885748:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.depthFirstLabelsInheritAttributes=function depthFirstLabelsInheritAttributes(e,t,n){for(let i of e){let e=i.attributes?{...n,...i.attributes}:n,r={name:i.name,attributes:e};if(t.push(r),i.children){let n=depthFirstLabelsInheritAttributes(i.children,t,e);t=[...n]}}return t},t.depthFirstLabels=depthFirstLabels,t.mergeLabelAttributes=function(e){let t=function(e){let t=new Map;for(let n of depthFirstLabels(e)){let e=t.get(n.name)??[];r.default.each(n.children,i=>{t.set(i.name,[...e,n])})}return t}(e),n=new Map;for(let i of depthFirstLabels(e)){let e=r.default.map(t.get(i.name),e=>e.attributes),o=r.default.compact([...e,i.attributes]);n.set(i.name,r.default.assign({},...o))}return n};var i,r=(i=n(298784))&&i.__esModule?i:{default:i};function*depthFirstLabels(e){for(let t of e)yield t,t.children&&(yield*depthFirstLabels(t.children))}}}]);